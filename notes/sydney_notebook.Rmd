---
title: "sydney-notebook"
output: html_document
date: "2025-06-16"
---

```{r}
#Author: [Sydney Stanton]

#Author Date: 06/09/2025
#Purpose: The purpose of this notebook is to house all data set transformation, cleansing, visualization, statistical analysis, and note-taking for the 2025 CU Athletic Department Sports Science Internship Program

#LAST UPDATED: 06/17/2025
library(tidyverse)
library(readxl)
library(aod)
library(tidyverse)
library(tidyr)
library(dplyr)
library(ggplot2)
library(lubridate)
```

```{r}
#load all of the useful datasets
ACWR <- read.csv("~/T2P1-data-analysis-2025/data-sets/ACWR-Catapult FB.csv")
catapult <- read.csv("~/T2P1-data-analysis-2025/data-sets/Catapult Session - Outdoor FB.csv")
incident <- read.csv("~/T2P1-data-analysis-2025/data-sets/Incident Report FB.csv")
perfnorm <- read.csv("~/T2P1-data-analysis-2025/data-sets/Performance Normative Data FB.csv")
perfrisk <- read.csv("~/T2P1-data-analysis-2025/data-sets/Performance Risk Assessment FB.csv")
riskstatus <- read.csv("~/T2P1-data-analysis-2025/data-sets/Soft Tissue Risk Status Report FB.csv")
strengthtest <- read.csv("~/T2P1-data-analysis-2025/data-sets/Strength Testing Data FB.csv")
VALD <- read.csv("~/T2P1-data-analysis-2025/data-sets/VALD - Performance Test FB.csv")
wellness <- read.csv("~/T2P1-data-analysis-2025/data-sets/Wellness Report FB.csv")
```

## Data Cleaning 

##1.ACWR
```{r}
#refined ACWR dataset 
ACWR <- ACWR %>%
  filter(Sport=="FOOTBALL")
Acwr <- subset(ACWR,select=c("anon_id","Date","Position","Total.Player.Load","Acute.Total.Acceleration.Load.EWMA","Acceleration.Load.ACWR","Acceleration.Load.EWMA.ACWR","Player.Load.ACWR","Total.Distance.ACWR","Month","Year"))

#cut back to last 12 months (last year)
Acwr$Date <- mdy(Acwr$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)

acwr_merge <- Acwr %>%
  select(-c('Month', 'Year')) %>%
  na.omit() %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y'))

filtered_Acwr <- Acwr %>%
  filter(Date >= start_date) %>%
  na.omit() %>%
  group_by(anon_id, Month, Year, Position) %>%
  summarise(Total.Player.Load = mean(Total.Player.Load, na.rm = TRUE),
            Acceleration.Load.EWMA.ACWR = mean(Acceleration.Load.EWMA.ACWR, na.rm = TRUE),
            Acceleration.Load.ACWR = mean(Acceleration.Load.ACWR, na.rm = TRUE),
            Player.Load.ACWR = mean(Player.Load.ACWR, na.rm = TRUE),
            Acute.Total.Acceleration.Load.EWMA=mean(Acute.Total.Acceleration.Load.EWMA, na.rm=TRUE),
            Total.Distance.ACWR = mean(Total.Distance.ACWR, na.rm = TRUE)) %>%
  ungroup()
```
```{r}
min(filtered_Acwr$Date,na.rm=TRUE)
max(filtered_Acwr$Date,na.rm=TRUE)
```

```{r}
ggplot(Acwr, aes(Acceleration.Load.EWMA.ACWR)) + 
  geom_histogram(bins = 30, fill = 'royalblue', color = 'black') + 
  labs(title = 'Distribution of Total Player Load',
       x = 'Total Player Load',
       y = 'Number of Players') +
  theme_bw()

Acwr_HSI <- Acwr %>%
  filter(anon_id == 'ID_95', '2024-07-01' < Date & Date < '2024-12-01')

ggplot(Acwr_HSI, aes(Acceleration.Load.EWMA.ACWR)) + 
  geom_histogram(bins = 30, fill = 'royalblue', color = 'black') + 
  labs(title = 'Distribution of Total Player Load in Players with HSI',
       x = 'Total Player Load',
       y = 'Number of Players') +
  theme_bw()
```

## 2. Catapult 
```{r}
catapult <- read.csv("~/T2P1-data-analysis-2025/data-sets/Catapult Session - Outdoor FB.csv")
```

```{r}
#refined catapult session outdoor dataset
catapult <- catapult %>%
filter(Sport=="FOOTBALL")

catapult <- subset(catapult,select=c("anon_id", "Position", "Date", "High.Speed.Distance", "Very.High.Speed.Distance", "Maximum.Velocity", "Average.Velocity","IMA.Accel.Low", "IMA.Decel.Low", "IMA.Accel.Medium", "IMA.Decel.Medium", "IMA.Accel.High", "IMA.Decel.High", "IMA.Accel.Total", "IMA.Decel.Total", "Explosive.Efforts","Total.Player.Load","Average.IMA","Max.Acceleration","Max.Deceleration"))

catapult$Date <- mdy(catapult$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)

filtered_catapult <- catapult %>%
  filter(Date >= start_date) %>%
  group_by(anon_id, Date, Position) %>%
  summarise(High.Speed.Distance = sum(High.Speed.Distance, na.rm = TRUE),
            Very.High.Speed.Distance = sum(Very.High.Speed.Distance, na.rm = TRUE),
            Max.Acceleration= mean(Max.Acceleration,na.rm=TRUE),
            Max.Deceleration= mean(Max.Deceleration, na.rm=TRUE),
            Maximum.Velocity = mean(Maximum.Velocity, na.rm = TRUE),
            Average.Velocity = mean(Average.Velocity, na.rm = TRUE),
            Average.IMA= mean(Average.IMA, na.rm=TRUE),
            IMA.Accel.Low = sum(IMA.Accel.Low, na.rm = TRUE),
            IMA.Decel.Low = sum(IMA.Decel.Low, na.rm = TRUE),
            IMA.Accel.Medium = sum(IMA.Accel.Medium, na.rm = TRUE),
            IMA.Decel.Medium = sum(IMA.Decel.Medium, na.rm = TRUE),
            IMA.Accel.High = sum(IMA.Accel.High, na.rm = TRUE),
            IMA.Decel.High = sum(IMA.Decel.High, na.rm = TRUE),
            IMA.Accel.Total = sum(IMA.Accel.Total, na.rm = TRUE),
            IMA.Decel.Total = sum(IMA.Decel.Total, na.rm = TRUE),
            Explosive.Efforts = sum(Explosive.Efforts, na.rm = TRUE))

Catapult2 <- catapult %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  group_by(anon_id, Date, Position) %>%
  summarise(High.Speed.Distance = sum(High.Speed.Distance, na.rm = TRUE),
            Very.High.Speed.Distance = sum(Very.High.Speed.Distance, na.rm = TRUE),
            Maximum.Velocity = mean(Maximum.Velocity, na.rm = TRUE),
            Average.Velocity = mean(Average.Velocity, na.rm = TRUE),
            IMA.Accel.Low = sum(IMA.Accel.Low, na.rm = TRUE),
            IMA.Decel.Low = sum(IMA.Decel.Low, na.rm = TRUE),
            IMA.Accel.Medium = sum(IMA.Accel.Medium, na.rm = TRUE),
            IMA.Decel.Medium = sum(IMA.Decel.Medium, na.rm = TRUE),
            IMA.Accel.High = sum(IMA.Accel.High, na.rm = TRUE),
            IMA.Decel.High = sum(IMA.Decel.High, na.rm = TRUE),
            IMA.Accel.Total = sum(IMA.Accel.Total, na.rm = TRUE),
            IMA.Decel.Total = sum(IMA.Decel.Total, na.rm = TRUE),
            Explosive.Efforts = sum(Explosive.Efforts, na.rm = TRUE),
            Total.Player.Load = sum(Total.Player.Load, na.rm = TRUE),
            Average.IMA = mean(Average.IMA, na.rm = TRUE),
            Max.Acceleration = max(Max.Acceleration, na.rm = TRUE),
            Max.Deceleration = min(Max.Deceleration, na.rm = TRUE))
```
```{r}
min(filtered_catapult$Date,na.rm=TRUE)
max(filtered_catapult$Date,na.rm=TRUE)
```

```{r}
#IMAs are counted variable so sum these
mean(catapult$High.Speed.Distance,na.rm=TRUE)
mean(catapult$Maximum.Velocity,na.rm=TRUE)
mean(catapult$Total.Player.Load,na.rm=TRUE)
mean(catapult$Player.Load.min,na.rm=TRUE)

#Maximum + average of the maximum & average velocity (given to us)
max(catapult$Maximum.Velocity,na.rm=TRUE)
mean(catapult$Average.Velocity,na.rm=TRUE)
```

## 3. Incident 
```{r}
incident <- read.csv("~/T2P1-data-analysis-2025/data-sets/Incident Report FB.csv")
```

```{r}
#sort out any non football values + etc
incident <- incident %>%
filter(Sport=="FOOTBALL") %>%
filter(Incident.Type=="Injury") %>%
filter(Result.of.Sport.Participation=="Yes")

filtered_incident <- subset(incident,select=c("anon_id", "Position", "Date.of.Injury...Onset.of.symptoms", "Side", "Body.Part", "Tissue.Type", "Pathology.Type", "OSICS14.Code", "OSICS10.Code", "OSICS10.Diagnosis", "Final.Diagnosis", "Result.of.Sport.Participation", "Recurrence.of.Injury", "Injury.Prognosis", "General.Mechanism", "Specific.Mechanism", "FinalDiagnosisIncidentDate", "Total.Time.Injured", "Month", "Year","Incident.Type"))[-c(1167,1168),]

#cut back to last year
filtered_incident$Date <- mdy(filtered_incident$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)
filtered_incident <- filtered_incident %>%
  filter(Date >= start_date)
```

```{r, warning = FALSE}
lower_body <- c("Thigh", "Ankle", "Lower Leg", "Knee", "Foot", "Groin/hip")
hamstring_OSICS14 <- c('TM1', 'TMB', 'TMS')

#filter for just hamstring related injuries and get rid of duplicate observations
incident_HSI <- filtered_incident %>%
  filter(OSICS14.Code %in% hamstring_OSICS14) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE),
         Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

#filter for just injuries in the lower body and get rid of duplicate observations
incident_lower <- filtered_incident %>%
  filter(Body.Part %in% lower_body) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE),
         Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

#creating a list of players who experienced HSI
players_HSI <- unique(incident_HSI$anon_id)

#consolidate same players into one observation
incident_HSI2 <- incident_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(Date, collapse = " and ")) %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ')
```

## 4. Performance Normative data
```{r}
filtered_perfnorm <- subset(perfnorm,select=c("anon_id","Date","Position","Nordic.Average","Nordic.Imbalance..","Adduction.Abduction.Ratio","Eccentric.Peak.Power...Relative","Jump.Height","Modified.RSI"))

#cut back to last year
filtered_perfnorm$Date <- mdy(filtered_perfnorm$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)

perfnorm_merge <- filtered_perfnorm %>%
  filter(Date >= start_date) %>%
  select(-Position) %>%
  #group_by(anon_id, Date) %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()
 

#can compare to NFL + NBA aswell
min(filtered_perfnorm$Date,na.rm=TRUE)
max(filtered_perfnorm$Date,na.rm=TRUE)
```

## 5. Performance Risk Assessment 
DATASET ONLY FROM ONE DAY OF LAST YEAR.

```{r}
#filter football
perfrisk <- perfrisk %>%
  filter(Sport=="FOOTBALL")
#ALL variables are relevant
filtered_perfrisk <- subset(perfrisk,select=c("anon_id", "Date","Hamstring.Avg..Imbalance", "L..Hamstring.Max.Force","R..Hamstring.Max.Force","L..Eccentric.Mean.Force","R..Eccentric.Mean.Force","Eccentric.Mean.Force.Asym","CMJ.Landing.Asym.","CMJ.Jump.Height","Groin.Avg..Imbalance", "Relative.Peak.Power","CMJ.Peak.Force","IMTP.Peak.Force"))

filtered_perfrisk <- filtered_perfrisk %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()
```

## 6. Soft Tissue Risk Status
```{r}
riskstatus <- read.csv("~/T2P1-data-analysis-2025/data-sets/Soft Tissue Risk Status Report FB.csv")
```

```{r}
#refined risk status dataset
#contains variable, what we are comparing against// validating 
riskstatus <- riskstatus[,-c(1,5)]

#cut back to last year
riskstatus$Date <- mdy(riskstatus$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)
riskstatus <- riskstatus %>%
  filter(Date >= start_date) #215 -> 100 obs.

#binary could be useful when testing accuracy/importance of high risk status
Highrisk_binary=ifelse(riskstatus$Status=="High",1,0)
#cbind(Riskstatus,Highrisk_binary)

riskstatus$Highrisk_binary = Highrisk_binary

merge_risk <- riskstatus %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y'))

min(riskstatus$Date,na.rm=TRUE)
max(riskstatus$Date,na.rm=TRUE)
```

## Validating the Soft-Tissue Watchlist
```{r}
#filtering just the high risk athletes from the watchlist
Riskstatus_high <- riskstatus %>%
  filter(Status == 'High') %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(DateRisk = paste0(Date, collapse = " and "))

#creating a list of the unique athlete ids that were deemed high risk
high_risk <- unique(Riskstatus_high$anon_id)
```


## 7. Stength Test
```{r}
#not expected to use this dataset alot + no real need to filter atm 
strengthtest <- read.csv("~/T2P1-data-analysis-2025/data-sets/Strength Testing Data FB.csv")
```

```{r}
#cut back to last year
strengthtest$Date <- mdy(strengthtest$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)
filtered_strength <- strengthtest %>%
  filter(Date >= start_date) %>%  # 224 -> 26 obs.
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()

strgth_merge <- strengthtest %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()


min(strengthtest$Date,na.rm=TRUE)
max(strengthtest$Date,na.rm=TRUE)
```

## 8. VALD Performance Test 
```{r}
filtered_VALD <- subset(VALD, select = c("anon_id","Date", "Session.Date", "Trend", "Maximum.Force","Average.Force","Impulse", "Percent.Difference.Norm", "Nordic.Left.MAX", "Nordic.Right.MAX", "Nordic.MEAN.Imbalance.with.side","Nordic.Left.Z.Score", "Nordic.Right.Z.Score", "Positional.Norm","Hip.Abd.Trend","Hip.Add.Trend", "Nordic...Difference.from.First.Test", "Month", "Year"))  #can add position back if needed 

#cut back to last year
filtered_VALD$Date <- mdy(filtered_VALD$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)
filtered_VALD <- filtered_VALD %>%
  filter(Date >= start_date)

vald_merge <- filtered_VALD %>%
  select(-c('Month', 'Year')) %>%
  mutate(Date = as.Date(Session.Date, format = '%m/%d/%Y')) %>%
  na.omit()

##CHANGED THIS ON THIS BUT NOT THE MERGE DOCUMENT 
filtered_VALD <- filtered_VALD %>%
  select(-c('Month', 'Year')) %>%
  mutate(Session.Date = as.Date(Session.Date, format = '%m/%d/%Y')) %>%
  group_by(anon_id, Trend) %>%
  summarise(Maximum.Force = mean(Maximum.Force, na.rm = TRUE),
            Average.Force= mean(Average.Force, na.rm=TRUE),
              Impulse= mean(Impulse, na.rm=TRUE),
            Percent.Difference.Norm = mean(Percent.Difference.Norm, na.rm = TRUE),
            Nordic.Left.MAX = mean(Nordic.Left.MAX, na.rm = TRUE),
            Nordic.Right.MAX = mean(Nordic.Right.MAX, na.rm = TRUE),
            Nordic.MEAN.Imbalance.with.side = mean(Nordic.MEAN.Imbalance.with.side, na.rm = TRUE),
            Nordic.Left.Z.Score= mean(Nordic.Left.Z.Score, na.rm=TRUE),
            Nordic.Right.Z.Score= mean(Nordic.Right.Z.Score, na.rm=TRUE),
            Positional.Norm = mean(Positional.Norm, na.rm = TRUE),
            Hip.Abd.Trend= mean(Hip.Abd.Trend, na.rm=TRUE),
            Hip.Add.Trend=mean(Hip.Add.Trend, na.rm=TRUE),
            Nordic...Difference.from.First.Test = mean(Nordic...Difference.from.First.Test, na.rm = TRUE)) %>%
  ungroup()

#min(filtered_VALD$Date,na.rm=TRUE)
#max(filtered_VALD$Date,na.rm=TRUE)
```


## 9. Wellness
```{r}
wellness <- read.csv("~/T2P1-data-analysis-2025/data-sets/Wellness Report FB.csv")
```

```{r}
wellness <- wellness %>%
  filter(Sport=="FOOTBALL")

#mental score, physical score,sleep quality score, soreness scores, + overall wellness all relevant 
filtered_wellness <- subset(wellness, select=c("anon_id","Date","Mental.Score","Physical.Score", "Sleep.Quality.Score","Soreness.Score","Overall.Wellness.Score","Wellness.Compliance","Month","Year"))

#cut back to last year
filtered_wellness$Date <- mdy(filtered_wellness$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)
filtered_wellness <- filtered_wellness %>%
  filter(Date >= start_date) 

#omit the N/A's
filtered_wellness <- filtered_wellness %>%
  group_by(anon_id, Month, Year) %>%
  summarise(Mental.Score = mean(Mental.Score),
            Physical.Score = mean(Physical.Score),
            Sleep.Quality.Score = mean(Sleep.Quality.Score),
            Soreness.Score = mean(Soreness.Score),
            Overall.Wellness.Score = mean(Overall.Wellness.Score))
  
  
filtered_wellness <- filtered_wellness %>%
  select(-c('Month', 'Year')) %>%
  #mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()

min(filtered_wellness$Date,na.rm=TRUE)
max(filtered_wellness$Date,na.rm=TRUE)
```


# Attempting to Merge Datasets into One filtered by date
Already filtered every dataset to the past year. 
-creating Incident Report with Start and End Dates

1. Merging Incident
```{r, warning = FALSE}
#creates a data frame with HSI injury dates for each player that experienced HSI with start dates on last HSI date or 6 months earlier if no previous HSI
HSI_last_injury <- incident_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Dates.Final = paste0(Date, collapse = " and "),
            Mechanism = paste0(General.Mechanism, collapse = " and "),
            Recurrence = paste0(Recurrence.of.Injury, collapse = " and "),
            Time.Injured = paste0(Total.Time.Injured, collapse = " and ")) %>%
  separate(Dates.Final, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  mutate(Injury.1.Start = as.Date(Injury.1) - months(6),
         Injury.2.Start = ifelse(is.na(Injury.2), NA, Injury.1),
         Injury.3.Start = ifelse(is.na(Injury.3), NA, Injury.2),
         Injury.4.Start = ifelse(is.na(Injury.4), NA, Injury.3)) %>%
  separate(Mechanism, c('Injury.1.Mech', 'Injury.2.Mech', 'Injury.3.Mech', 'Injury.4.Mech'), sep = ' and ') %>%
  separate(Recurrence, c('Injury.1.Recur', 'Injury.2.Recur', 'Injury.3.Recur', 'Injury.4.Recur'), sep = ' and ') %>%
  separate(Time.Injured, c('Injury.1.Time', 'Injury.2.Time', 'Injury.3.Time', 'Injury.4.Time'), sep = ' and ')
```

```{r}
#trying to merge hamstring injuries with other lower body injuries
merge_incid <- merge(HSI_last_injury, incident_HSI, by = c('anon_id'), all = TRUE)

merge_incid <- merge_incid %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, ifelse(Date > Injury.4, 'After', 0)))))) %>%
  filter(is.na(Group) | Group != 'After')

merge_incid <- merge_incid %>%
  mutate(Mechanism = ifelse(Group == 4, Injury.4.Mech, ifelse(Group == 3, Injury.3.Mech, ifelse(Group == 2, Injury.2.Mech, ifelse(Group == 1, Injury.1.Mech, NA)))),
         Recurrence = ifelse(Group == 4, Injury.4.Recur, ifelse(Group == 3, Injury.3.Recur, ifelse(Group == 2, Injury.2.Recur, ifelse(Group == 1, Injury.1.Recur, NA)))),
         Time.Injured = ifelse(Group == 4, Injury.4.Time, ifelse(Group == 3, Injury.3.Time, ifelse(Group == 2, Injury.2.Time, ifelse(Group == 1, Injury.1.Time, NA))))) %>%
  group_by(anon_id, Group, Mechanism, Recurrence, Time.Injured) %>%
  summarise(OSICS14.Code = paste0(OSICS14.Code, collapse = " and ")) %>%
  mutate(Injuries.Last.3.Months = ifelse(is.na(Group) | Group == 0, sapply(strsplit(OSICS14.Code, " and "), length), sapply(strsplit(OSICS14.Code, " and "), length) - 1))
```

2. Merging Wellness
```{r}
#selecting only the variables of interest: important to not that this only contains data from may to december of 2024
Wellness <- subset(wellness, select = c("anon_id", "Date", "Mental.Score", "Physical.Score", "Sleep.Quality.Score", "Soreness.Score", "Overall.Wellness.Score", "Month", "Year"))

Wellness_merge <- Wellness %>%
  select(-c('Month', 'Year')) %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()
```

```{r}
#merges the HSI_last_injury with wellness by anon_id
merge_well <- merge(HSI_last_injury, Wellness_merge, by = c('anon_id'), all = TRUE)

#creates a variable called Group that groups the observations into the intervals that they occurred in in relation to the athletes injuries: 1 if observation is within 6 months of first injury, 2 if between injuries 1 and 2, 3 if between injuries 2 and 3 and 4 if between injuries 3 and 4. This variable is 0 if occurred before 6 months prior to injury and NA if player never sustained injury
merge_well <- merge_well %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date<= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

#groups observations by the player id and which period the observation falls under then averages all numerical variables
merge_well <- merge_well %>%
  group_by(anon_id, Group) %>%
  summarise(Mental.Score = mean(Mental.Score),
            Physical.Score = mean(Physical.Score),
            Sleep.Quality.Score = mean(Sleep.Quality.Score),
            Soreness.Score = mean(Soreness.Score),
            Overall.Wellness.Score = mean(Overall.Wellness.Score))
```
3. Merging VALD
```{r}
merge_vald <- merge(HSI_last_injury, vald_merge, by = c('anon_id'), all = TRUE)

merge_vald <- merge_vald %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

merge_vald <- merge_vald %>%
  group_by(anon_id, Group) %>%
  summarise(Maximum.Force = mean(Maximum.Force, na.rm = TRUE),
            Percent.Difference.Norm = mean(Percent.Difference.Norm, na.rm = TRUE),
            Nordic.Left.MAX = mean(Nordic.Left.MAX, na.rm = TRUE),
            Nordic.Right.MAX = mean(Nordic.Right.MAX, na.rm = TRUE),
            Nordic.Left.Z.Score = mean(Nordic.Left.Z.Score, na.rm = TRUE),
            Nordic.Right.Z.Score = mean(Nordic.Right.Z.Score, na.rm = TRUE),
            Nordic.MEAN.Imbalance.with.side = mean(Nordic.MEAN.Imbalance.with.side, na.rm = TRUE),
            Positional.Norm = mean(Positional.Norm, na.rm = TRUE),
            Nordic...Difference.from.First.Test = mean(Nordic...Difference.from.First.Test, na.rm = TRUE))
```

4. Merging Catapult
```{r}
merge_catapult <- merge(HSI_last_injury, Catapult2, by = c('anon_id'), all = TRUE)

merge_catapult <- merge_catapult %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

merge_catapult <- merge_catapult %>%
  group_by(anon_id, Group) %>%
  summarise(High.Speed.Distance = sum(High.Speed.Distance, na.rm = TRUE),
            Very.High.Speed.Distance = sum(Very.High.Speed.Distance, na.rm = TRUE),
            Maximum.Velocity = mean(Maximum.Velocity, na.rm = TRUE),
            Average.Velocity = mean(Average.Velocity, na.rm = TRUE),
            IMA.Accel.Low = sum(IMA.Accel.Low, na.rm = TRUE),
            IMA.Decel.Low = sum(IMA.Decel.Low, na.rm = TRUE),
            IMA.Accel.Medium = sum(IMA.Accel.Medium, na.rm = TRUE),
            IMA.Decel.Medium = sum(IMA.Decel.Medium, na.rm = TRUE),
            IMA.Accel.High = sum(IMA.Accel.High, na.rm = TRUE),
            IMA.Decel.High = sum(IMA.Decel.High, na.rm = TRUE),
            IMA.Accel.Total = sum(IMA.Accel.Total, na.rm = TRUE),
            IMA.Decel.Total = sum(IMA.Decel.Total, na.rm = TRUE),
            Explosive.Efforts = sum(Explosive.Efforts, na.rm = TRUE),
            Total.Player.Load = sum(Total.Player.Load, na.rm = TRUE),
            Average.IMA = mean(Average.IMA, na.rm = TRUE),
            Max.Acceleration = max(Max.Acceleration, na.rm = TRUE),
            Max.Deceleration = min(Max.Deceleration, na.rm = TRUE))
```

5. Merging ACWR
```{r}
merge_acwr <- merge(HSI_last_injury, acwr_merge, by = c('anon_id'), all = TRUE)

merge_acwr <- merge_acwr %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

merge_acwr <- merge_acwr %>%
  group_by(anon_id, Group) %>%
  summarise(Total.Player.Load = mean(Total.Player.Load, na.rm = TRUE),
            Acceleration.Load.EWMA.ACWR = mean(Acceleration.Load.EWMA.ACWR, na.rm = TRUE),
            Acceleration.Load.ACWR = mean(Acceleration.Load.ACWR, na.rm = TRUE),
            Player.Load.ACWR = mean(Player.Load.ACWR, na.rm = TRUE),
            Total.Distance.ACWR = mean(Total.Distance.ACWR, na.rm = TRUE))
```

6. Merging Soft Tissue
```{r}
merge_risk <- merge(HSI_last_injury, merge_risk, by = c('anon_id'), all = TRUE)

merge_risk <- merge_risk %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

merge_risk <- merge_risk %>%
  select(anon_id, Group, Status) %>%
  group_by(across(all_of(non_numeric_cols))) %>%
  group_by(across(where(is.numeric))) %>%
  summarise(.groups = 'drop')
```

7. Merging Perfnorm
```{r}
merge_perfnorm <- merge(HSI_last_injury, perfnorm_merge, by = c('anon_id'), all = TRUE)

merge_perfnorm <- merge_perfnorm %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

merge_perfnorm <- merge_perfnorm %>%
  group_by(anon_id, Group) %>%
  summarise(Nordic.Average = mean(Nordic.Average, na.rm = TRUE),
            Nordic.Imbalance.. = mean(Nordic.Imbalance.., na.rm = TRUE),
            Adduction.Abduction.Ratio = mean(Adduction.Abduction.Ratio, na.rm = TRUE),
            Eccentric.Peak.Power...Relative = mean(Eccentric.Peak.Power...Relative, na.rm = TRUE),
            Jump.Height = mean(Jump.Height, na.rm = TRUE),
            Modified.RSI = mean(Modified.RSI, na.rm = TRUE))
```

8. Merging Strength Test
```{r}
merge_strgth <- merge(HSI_last_injury, strgth_merge, by = c('anon_id'), all = TRUE)

merge_strgth <- merge_strgth %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

merge_strgth <- merge_strgth %>%
  group_by(anon_id, Group) %>%
  summarise(Left.Quad.Force = mean(Left.Quad.Force, na.rm = TRUE),
            Right.Quad.Force = mean(Right.Quad.Force, na.rm = TRUE),
            Left.Hamstring.Force..Nordic. = mean(Left.Hamstring.Force..Nordic., na.rm = TRUE),
            Right.Hamstring.Force..Nordic. = mean(Right.Hamstring.Force..Nordic., na.rm = TRUE),
            Left.Hamstring.Quad.Ratio = mean(Left.Hamstring.Quad.Ratio, na.rm = TRUE),
            Right.Hamstring.Quad.Ratio = mean(Right.Hamstring.Quad.Ratio, na.rm = TRUE),
            Left.Hamstring.Quad.Percentage = mean(Left.Hamstring.Quad.Percentage, na.rm = TRUE),
            Right.Hamstring.Quad.Percentage = mean(Right.Hamstring.Quad.Percentage, na.rm = TRUE))
```

##Merging All Datasets Together
```{r}
#merging wellness with VALD
final_merge_full <- merge(merge_well, merge_vald, by = c('anon_id', 'Group'), all = TRUE)
#merging catapult
final_merge_full <- merge(final_merge_full, merge_catapult, by = c('anon_id', 'Group'), all = TRUE)
#merging ACWR
final_merge_full <- merge(final_merge_full, merge_acwr, by = c('anon_id', 'Group'), all = TRUE)
#merging risk status
final_merge_full <- merge(final_merge_full, merge_risk, by = c('anon_id', 'Group'), all = TRUE)
#merging performance normative data
final_merge_full <- merge(final_merge_full, merge_perfnorm, by = c('anon_id', 'Group'), all = TRUE)
#merging strength testing data, does lower number of observations in final_merge
final_merge_full <- merge(final_merge_full, merge_strgth, by = c('anon_id', 'Group'), all = TRUE)

#making a binary indicator variable HSI and ommitting the N/As
final_merge <- final_merge_full %>%
  mutate(Group = ifelse(is.na(Group), 0, Group),
         HSI = ifelse(Group > 0, 1, 0)) %>%
  select(-Group) %>%
  na.omit()
```

## 3 Months Prior Emphasis from Blake

```{r, warning = FALSE}
#generates a date for 3 months from the injury and then collapses the injury dates and 3 month prior dates into many columns (4 injuries per player) for each player 
HSI_3_months <- incident_lower %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y'),
         start_date = Date - months(3)) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Dates.Final = paste0(FinalDiagnosisIncidentDate, collapse = " and "),
            Dates.Start = paste0(start_date, collapse = " and "),
            Mechanism = paste0(General.Mechanism, collapse = " and ")) %>%
  separate(Dates.Final, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4', 'Injury.5', 'Injury.6', 'Injury.7', 'Injury.8'), sep = ' and ') %>%
  separate(Dates.Start, c('Injury.1.Start', 'Injury.2.Start', 'Injury.3.Start', 'Injury.4.Start', 'Injury.5.Start', 'Injury.6.Start', 'Injury.7.Start', 'Injury.8.Start'), sep = ' and ') %>%
  separate(Mechanism, c('Injury.1.Mech', 'Injury.2.Mech', 'Injury.3.Mech', 'Injury.4.Mech', 'Injury.5.Mech', 'Injury.6.Mech', 'Injury.7.Mech', 'Injury.8.Mech'), sep = ' and ')
```

```{r, warning = FALSE}
#generates a date for 3 months from the injury and then collapses the injury dates and 3 month prior dates into 8 columns (4 injuries per player) for each player 
HSI_3_months <- incident_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y'),
         start_date = Date - months(3)) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Dates.Final = paste0(Date, collapse = " and "),
            Dates.Start = paste0(start_date, collapse = " and ")) %>%
  separate(Dates.Final, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(Dates.Start, c('Injury.1.Start', 'Injury.2.Start', 'Injury.3.Start', 'Injury.4.Start'), sep = ' and ')
```

2. Merging VALD
```{r}
merge_vald <- merge(HSI_3_months, vald_merge, by = c('anon_id'), all = TRUE)

merge_vald <- merge_vald %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, ifelse(Date > Injury.4, 'After', 0)))))) %>%
  filter(is.na(Group) | Group != 'After')

merge_vald <- merge_vald %>%
  group_by(anon_id, Group) %>%
  summarise(Maximum.Force = mean(Maximum.Force, na.rm = TRUE),
            Percent.Difference.Norm = mean(Percent.Difference.Norm, na.rm = TRUE),
            Nordic.Left.MAX = mean(Nordic.Left.MAX, na.rm = TRUE),
            Nordic.Right.MAX = mean(Nordic.Right.MAX, na.rm = TRUE),
            Nordic.MEAN.Imbalance.with.side = mean(Nordic.MEAN.Imbalance.with.side, na.rm = TRUE),
            Positional.Norm = mean(Positional.Norm, na.rm = TRUE),
            Nordic...Difference.from.First.Test = mean(Nordic...Difference.from.First.Test, na.rm = TRUE))
```

```{r}
#trying to merge hamstring injuries with other lower body injuries
merge_lower <- merge(HSI_3_months, incident_lower, by = c('anon_id'), all = TRUE)

merge_lower <- merge_lower %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, ifelse(Date > Injury.4, 'After', 0)))))) %>%
  filter(is.na(Group) | Group != 'After')

merge_lower <- merge_lower %>%
  group_by(anon_id, Group) %>%
  summarise(FinalDiagnosisIncidentDate = paste0(FinalDiagnosisIncidentDate, collapse = " and "),
            Recurrence.of.Injury = paste0(Recurrence.of.Injury, collapse = " and "),
            General.Mechanism = paste0(General.Mechanism, collapse = " and "))
```


## Exploratory Analysis: descriptive stats + plots
```{r}
ggplot(filtered_vald, aes(x = Maximum.Force)) + 
  geom_histogram(bins = 30, fill = 'royalblue', color = 'black') + 
  labs(title = 'Distribution of Nordic Maximum Force',
       x = 'Maximum Force',
       y = 'Number of Athletes') +
  theme_bw()

ggplot(data = filtered_wellness, aes(x = Overall.Wellness.Score)) + 
  geom_histogram(bins = 30, color = 'black', fill = 'royalblue') +
  theme_bw()
```

```{r}
#MERGE Incident and Riskstatus datasets
df <- merge(riskstatus,filtered_incident,by="anon_id") 

#density plot of risk categories 
ggplot(riskstatus, aes(x=Status))+
  geom_bar(fill="lightblue")+
  labs(title="Risk Status Spread",x="Risk Status",y="Frequency")

ggplot(filtered_incident, aes(x=Position))+
  geom_bar(fill="lightblue")+
  labs(title="Positional Spread",x="Players Positions",y="Frequency")

#position by status
ggplot(df,aes(x=Position,y=Status))+  #scatterplot
  geom_point()+
  geom_jitter()+ 
  labs(title="Position Influence on Hamstring Risk Status",y="Risk Status")

ggplot(df,aes(x=Position,fill=Status))+   #stacked bar chart
  geom_bar(inherit.aes = TRUE)+
  scale_fill_brewer()
```

```{r}
#Nordic.Left.MAX , Nordic.Right.MAX , color== HSI
ggplot(data=final_merge, aes(x=Nordic.Left.MAX, y=Nordic.Right.MAX,color=factor(HSI)))+
  geom_point()

#Explosive.Efforts by Nordic.Average 
ggplot(data=final_merge,aes(x=Positional.Norm, y=Maximum.Force, color=factor(Status)))+
  geom_jitter()+
  geom_point()

ggplot(data=final_merge,aes(x=Physical.Score, y=Mental.Score, color=factor(Status)))+
  geom_point()


#Left.Hamstring.Force..Nordic. 
ggplot(data=final_merge, aes(x=Left.Hamstring.Force..Nordic., y=Right.Hamstring.Force..Nordic.,color=factor(HSI)))+
  geom_point()
```

```{r}
#density plot of Body. part density 
ggplot(df, aes(x=Body.Part))+
  geom_bar(fill="lightblue")+
  labs(title="Part of Body Injured Spread",x="Injured Body Part",y="Frequency")

ggplot(df, aes(x=Recurrence.of.Injury))+
  geom_bar(fill="lightblue")+
  labs(title="Recurrence of Injury Spread",x="Injury Recurrence",y="Frequency")

#distributions of strength/imbalance by risk category 
boxplot(Percent.Difference.Norm~Status,data=final_merge,lmain="Risk Status vs % Difference Norm", col="lightblue")
boxplot(Positional.Norm~Status,data=final_merge,lmain="Risk Status vs % Difference Norm", col="lightblue")
```

-Lower body injuries are most prevalent .With the thigh which includes the hamstring having the greatest quantity of injuries of the lower body.
-Recurrence of injuries is not as high as anticipated. New injuries is the biggest threat to our team.


## VALIDATION OF SOFT TISSUE WATCHLIST 
```{r, warning = FALSE}
#combines the dates the athletes were deemed high risk with their injuries and separates the injury occurrences and dates
validation_hr_all <- left_join(Riskstatus_high, incident_hr_all2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4', 'Injury.5', 'Injury.6', 'Injury.7', 'Injury.8'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

#combines the above but specifically for HSI and includes T/F for whether the athlete suffered their injury after their high risk assessment
validation_hr_HSI <- left_join(Riskstatus_high, incident_hr_HSI2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

validation_hr_HSI <- validation_hr_HSI %>%
  mutate(Injury.1.After = as.Date(str_sub(validation_hr_HSI$Injury.1, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.2.After = as.Date(str_sub(validation_hr_HSI$Injury.2, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.3.After = as.Date(str_sub(validation_hr_HSI$Injury.3, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.4.After = as.Date(str_sub(validation_hr_HSI$Injury.4, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.1.After.2 = as.Date(str_sub(validation_hr_HSI$Injury.1, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.2.After.2 = as.Date(str_sub(validation_hr_HSI$Injury.2, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.3.After.2 = as.Date(str_sub(validation_hr_HSI$Injury.3, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.4.After.2 = as.Date(str_sub(validation_hr_HSI$Injury.4, start = -10), format = '%m/%d/%Y') > Test.2)
         
#adds columns that return 'Yes' if an injury occurred after the athlete was deemed high risk and a 'No' if no injury occurred after
validation_hr_HSI <- validation_hr_HSI %>%
         mutate(Test.1.Success = ifelse(rowSums(validation_hr_HSI[, c('Injury.1.After', 'Injury.2.After', 'Injury.3.After', 'Injury.4.After')], na.rm = TRUE) > 0, 'Yes', 'No'),
         Test.2.Success = ifelse(is.na(validation_hr_HSI$Test.2), NA, ifelse(rowSums(validation_hr_HSI[, c('Injury.1.After.2', 'Injury.2.After.2', 'Injury.3.After.2', 'Injury.4.After.2')], na.rm = TRUE) > 0, 'Yes', 'No')))
```

```{r}
#combining tests and injury outcomes and creating a data frame that just contains the dates of the test results and whether an injury occurred for the athlete after these tests
tests_hr <- c(validation_hr_HSI$Test.1, validation_hr_HSI$Test.2)
outcomes_hr <- c(validation_hr_HSI$Test.1.Success, validation_hr_HSI$Test.2.Success)
tests_outcomes_hr <- data.frame(tests_hr, outcomes_hr) %>%
  na.omit

#calculating percent of the time right
mean(tests_outcomes_hr$outcomes == 'Yes')

#visualizing using a bar plot 
ggplot(tests_outcomes_hr, aes(x = outcomes_hr, fill = outcomes_hr)) + 
  geom_bar(color = 'black', show.legend = FALSE) +
  scale_fill_manual(values = c('gold2', 'grey2')) + 
  labs(title = 'Outcomes of Soft Tissue Watchlist (High Risk)',
       x = 'Injury Occured After Deemed High Risk',
       y = 'Number of Observations') + 
  theme_bw()
```

##REPEATED CODE// DECIDE WHICH VARIABLE NAMES USED AGAIN LATER AND KEEP THAT CODE CHUNKS
```{r, warning = FALSE}
#combines the dates the athletes were deemed high risk with their injuries and separates the injury occurrences and dates
validation_all <- left_join(Riskstatus_high, incident_hr_all2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4', 'Injury.5', 'Injury.6', 'Injury.7', 'Injury.8'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

#combines the above but specifically for HSI and includes T/F for whether the athlete suffered their injury after their high risk assessment
validation_HSI <- left_join(Riskstatus_high, incident_hr_HSI2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

validation_HSI <- validation_HSI %>%
  mutate(Injury.1.After = as.Date(str_sub(validation_HSI$Injury.1, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.2.After = as.Date(str_sub(validation_HSI$Injury.2, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.3.After = as.Date(str_sub(validation_HSI$Injury.3, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.4.After = as.Date(str_sub(validation_HSI$Injury.4, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.1.After.2 = as.Date(str_sub(validation_HSI$Injury.1, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.2.After.2 = as.Date(str_sub(validation_HSI$Injury.2, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.3.After.2 = as.Date(str_sub(validation_HSI$Injury.3, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.4.After.2 = as.Date(str_sub(validation_HSI$Injury.4, start = -10), format = '%m/%d/%Y') > Test.2)
         
#adds columns that return 'Yes' if an injury occurred after the athlete was deemed high risk and a 'No' if no injury occurred after
validation_HSI <- validation_HSI %>%
         mutate(Test.1.Success = ifelse(rowSums(validation_HSI[, c('Injury.1.After', 'Injury.2.After', 'Injury.3.After', 'Injury.4.After')], na.rm = TRUE) > 0, 'Yes', 'No'),
         Test.2.Success = ifelse(is.na(validation_HSI$Test.2), NA, ifelse(rowSums(validation_HSI[, c('Injury.1.After.2', 'Injury.2.After.2', 'Injury.3.After.2', 'Injury.4.After.2')], na.rm = TRUE) > 0, 'Yes', 'No')))
```

```{r}
#combining tests and injury outcomes and creating a data frame that just contains the dates of the test results and whether an injury occurred for the athlete after these tests
tests <- c(validation_HSI$Test.1, validation_HSI$Test.2)
outcomes <- c(validation_HSI$Test.1.Success, validation_HSI$Test.2.Success)
tests_outcomes <- data.frame(tests, outcomes) %>%
  na.omit

#calculating % of the time right
mean(tests_outcomes$outcomes == 'Yes')

#visualizing using a bar plot 
ggplot(tests_outcomes, aes(x = outcomes, fill = outcomes)) + 
  geom_bar(color = 'black', show.legend = FALSE) +
  scale_fill_manual(values = c('gold2', 'grey2')) + 
  labs(title = 'Outcomes of Soft Tissue Watchlist (High Risk)',
       x = 'Injury Occured After Deemed High Risk',
       y = 'Number of Observations') + 
  theme_bw()
```

Players ID_220 and ID_83 was deemed high risk on the same day they suffered a hamstring injury, I classified them into the not accurate category. Player ID_307 suffered a tendon injury (not strain/tear) after over 3 months from the test. Player_ID 32 suffered his injury in just over 2 months. Player ID_83 suffered his injury in just under 8 months from the first test. Player ID_85 had injuries after both tests, with the first coming within the month of the test and second coming within the month of the second test. Player ID_86 and ID_87 injured their hamstrings in just under 6 months from their first tests. Player ID_95 injured his hamstring once after just over a month and a second time after under 3 months from the same test. Player ID_98 suffered a single injury after both of his tests, it being under 5 months from the first test and within a month from the second.  


2. Players Deemed Low Risk
```{r}
#filtering just the low risk athletes from the watchlist
Riskstatus_low <- Riskstatus %>%
  filter(Status == 'Low') %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(DateRisk = paste0(Date, collapse = " and "))

#creating a list of the unique athlete ids that were deemed high risk
low_risk <- unique(Riskstatus_low$anon_id)
```

```{r}
#filtering the incident report to only show those deemed low risk with only lower body injuries as well as only HSI related injuries
incident_lr_all <- Incident %>%
  filter(anon_id %in% low_risk, Body.Part %in% lower_body) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

incident_lr_HSI <- Incident %>%
  filter(anon_id %in% low_risk, OSICS14.Code %in% hamstring_OSICS14) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

#consolidates all injuries for these athletes into one column
incident_lr_all2 <- incident_lr_all %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))

incident_lr_HSI2 <- incident_lr_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))
```

Player ID_194 has a duplicate injury with both 'Left Hamstring strain/tear' and 'Left Semimembranosis/tendinosis strain (grade 1 - 2)' being listed for 06/05/24. Player ID_360 has a duplicate injury with both 'Left Ankle sprains' and 'Left Peroneal tendinopathy' being listed for 11/21/24, but this is less important as it only relates to ankles.

```{r, warning = FALSE}
#combines the dates the athletes were deemed low risk with their injuries and separates the injury occurrences and dates
validation_lr_all <- left_join(Riskstatus_low, incident_lr_all2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4', 'Injury.5', 'Injury.6', 'Injury.7', 'Injury.8'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

#combines the above but specifically for HSI and includes T/F for whether the athlete suffered their injury after their low risk assessment
validation_lr_HSI <- left_join(Riskstatus_low, incident_lr_HSI2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

validation_lr_HSI <- validation_lr_HSI %>%
  mutate(Injury.1.After = as.Date(str_sub(validation_lr_HSI$Injury.1, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.2.After = as.Date(str_sub(validation_lr_HSI$Injury.2, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.3.After = as.Date(str_sub(validation_lr_HSI$Injury.3, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.4.After = as.Date(str_sub(validation_lr_HSI$Injury.4, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.1.After.2 = as.Date(str_sub(validation_lr_HSI$Injury.1, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.2.After.2 = as.Date(str_sub(validation_lr_HSI$Injury.2, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.3.After.2 = as.Date(str_sub(validation_lr_HSI$Injury.3, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.4.After.2 = as.Date(str_sub(validation_lr_HSI$Injury.4, start = -10), format = '%m/%d/%Y') > Test.2)
         
#adds columns that return 'Yes' if an injury occurred after the athlete was deemed low risk and a 'No' if no injury occurred after
validation_lr_HSI <- validation_lr_HSI %>%
         mutate(Test.1.Success = ifelse(rowSums(validation_lr_HSI[, c('Injury.1.After', 'Injury.2.After', 'Injury.3.After', 'Injury.4.After')], na.rm = TRUE) > 0, 'Yes', 'No'),
         Test.2.Success = ifelse(is.na(validation_lr_HSI$Test.2), NA, ifelse(rowSums(validation_lr_HSI[, c('Injury.1.After.2', 'Injury.2.After.2', 'Injury.3.After.2', 'Injury.4.After.2')], na.rm = TRUE) > 0, 'Yes', 'No')))
```

```{r}
#combining tests and injury outcomes and creating a data frame that just contains the dates of the test results and whether an injury occurred for the athlete after these tests
tests_lr <- c(validation_lr_HSI$Test.1, validation_lr_HSI$Test.2)
outcomes_lr <- c(validation_lr_HSI$Test.1.Success, validation_lr_HSI$Test.2.Success)
tests_outcomes_lr <- data.frame(tests_lr, outcomes_lr) %>%
  na.omit

#calculating percent of the time right
mean(tests_outcomes_lr$outcomes == 'Yes')

#visualizing using a bar plot 
ggplot(tests_outcomes_lr, aes(x = outcomes_lr, fill = outcomes_lr)) + 
  geom_bar(color = 'black', show.legend = FALSE) +
  scale_fill_manual(values = c('gold2', 'grey2')) + 
  labs(title = 'Outcomes of Soft Tissue Watchlist (Low Risk)',
       x = 'Injury Occured After Deemed Low Risk',
       y = 'Number of Observations') + 
  theme_bw()
```

Important to note that only two hamstring injuries occured in players deemed low risk with one occuring almost 6 months after being deemed low risk. The other player hurt his left hamstring 4 months after being deemed low risk and hurt his left hamstring two more times and even his right hamstring later.

3. Players Deemed Medium Risk

```{r}
#filtering just the low risk athletes from the watchlist
Riskstatus_med <- Riskstatus %>%
  filter(Status == 'Medium') %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(DateRisk = paste0(Date, collapse = " and "))

#creating a list of the unique athlete ids that were deemed high risk
med_risk <- unique(Riskstatus_med$anon_id)
```

```{r}
#filtering the incident report to only show those deemed low risk with only lower body injuries as well as only HSI related injuries
incident_med_all <- Incident %>%
  filter(anon_id %in% med_risk, Body.Part %in% lower_body) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

incident_med_HSI <- Incident %>%
  filter(anon_id %in% med_risk, OSICS14.Code %in% hamstring_OSICS14) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

#consolidates all injuries for these athletes into one column
incident_med_all2 <- incident_med_all %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))

incident_med_HSI2 <- incident_med_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))
```

Player ID_489 has a duplicate injury with both 'Left Knee medial collateral ligament injury' and 'Left Grade 2 MCL tear knee' being listed for 11/23/24, but this is not as important to us. Player ID_595 has a duplicate injury of 'Left Ankle sprains' on 08/15/24. 

```{r, warning = FALSE}
#combines the dates the athletes were deemed high risk with their injuries and separates the injury occurrences and dates
validation_med_all <- left_join(Riskstatus_med, incident_med_all2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4', 'Injury.5', 'Injury.6', 'Injury.7', 'Injury.8'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

#combines the above but specifically for HSI and includes T/F for whether the athlete suffered their injury after their high risk assessment
validation_med_HSI <- left_join(Riskstatus_med, incident_med_HSI2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

validation_med_HSI <- validation_med_HSI %>%
  mutate(Injury.1.After = as.Date(str_sub(validation_med_HSI$Injury.1, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.2.After = as.Date(str_sub(validation_med_HSI$Injury.2, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.3.After = as.Date(str_sub(validation_med_HSI$Injury.3, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.4.After = as.Date(str_sub(validation_med_HSI$Injury.4, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.1.After.2 = as.Date(str_sub(validation_med_HSI$Injury.1, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.2.After.2 = as.Date(str_sub(validation_med_HSI$Injury.2, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.3.After.2 = as.Date(str_sub(validation_med_HSI$Injury.3, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.4.After.2 = as.Date(str_sub(validation_med_HSI$Injury.4, start = -10), format = '%m/%d/%Y') > Test.2)
         
#adds columns that return 'Yes' if an injury occurred after the athlete was deemed high risk and a 'No' if no injury occurred after
validation_med_HSI <- validation_med_HSI %>%
         mutate(Test.1.Success = ifelse(rowSums(validation_med_HSI[, c('Injury.1.After', 'Injury.2.After', 'Injury.3.After', 'Injury.4.After')], na.rm = TRUE) > 0, 'Yes', 'No'),
         Test.2.Success = ifelse(is.na(validation_med_HSI$Test.2), NA, ifelse(rowSums(validation_med_HSI[, c('Injury.1.After.2', 'Injury.2.After.2', 'Injury.3.After.2', 'Injury.4.After.2')], na.rm = TRUE) > 0, 'Yes', 'No')))
```

```{r}
#combining tests and injury outcomes and creating a data frame that just contains the dates of the test results and whether an injury occurred for the athlete after these tests
tests_med <- c(validation_med_HSI$Test.1, validation_med_HSI$Test.2)
outcomes_med <- c(validation_med_HSI$Test.1.Success, validation_med_HSI$Test.2.Success)
tests_outcomes_med <- data.frame(tests_med, outcomes_med) %>%
  na.omit

#calculating percent of the time right
mean(tests_outcomes_med$outcomes == 'Yes')

#visualizing using a bar plot 
ggplot(tests_outcomes_med, aes(x = outcomes_med, fill = outcomes_med)) + 
  geom_bar(color = 'black', show.legend = FALSE) +
  scale_fill_manual(values = c('gold2', 'grey2')) + 
  labs(title = 'Outcomes of Soft Tissue Watchlist (Medium Risk)',
       x = 'Injury Occured After Deemed Medium Risk',
       y = 'Number of Observations') + 
  theme_bw()
```

There appear to be no observations of HSI following a player being deemed as "Medium" risk for injury.

4. Players Deemed Routine Risk
```{r}
#filtering just the low risk athletes from the watchlist
Riskstatus_rout <- Riskstatus %>%
  filter(Status == 'Routine') %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(DateRisk = paste0(Date, collapse = " and "))

#creating a list of the unique athlete ids that were deemed high risk
rout_risk <- unique(Riskstatus_rout$anon_id)
```

```{r}
#filtering the incident report to only show those deemed low risk with only lower body injuries as well as only HSI related injuries
incident_rout_all <- Incident %>%
  filter(anon_id %in% rout_risk, Body.Part %in% lower_body) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

incident_rout_HSI <- Incident %>%
  filter(anon_id %in% rout_risk, OSICS14.Code %in% hamstring_OSICS14) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

#consolidates all injuries for these athletes into one column
incident_rout_all2 <- incident_rout_all %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))

incident_rout_HSI2 <- incident_rout_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))
```

Player ID_489 has a duplicate injury with both 'Left Knee medial collateral ligament injury' and 'Left Grade 2 MCL tear knee' being listed for 11/23/24, but this is not as important to us. Player ID_595 has a duplicate injury of 'Left Ankle sprains' on 08/15/24. 

```{r, warning = FALSE}
#combines the dates the athletes were deemed high risk with their injuries and separates the injury occurrences and dates
validation_rout_all <- left_join(Riskstatus_rout, incident_rout_all2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4', 'Injury.5', 'Injury.6', 'Injury.7', 'Injury.8'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

#combines the above but specifically for HSI and includes T/F for whether the athlete suffered their injury after their high risk assessment
validation_rout_HSI <- left_join(Riskstatus_rout, incident_rout_HSI2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

validation_rout_HSI <- validation_rout_HSI %>%
  mutate(Injury.1.After = as.Date(str_sub(validation_rout_HSI$Injury.1, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.2.After = as.Date(str_sub(validation_rout_HSI$Injury.2, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.3.After = as.Date(str_sub(validation_rout_HSI$Injury.3, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.4.After = as.Date(str_sub(validation_rout_HSI$Injury.4, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.1.After.2 = as.Date(str_sub(validation_rout_HSI$Injury.1, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.2.After.2 = as.Date(str_sub(validation_rout_HSI$Injury.2, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.3.After.2 = as.Date(str_sub(validation_rout_HSI$Injury.3, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.4.After.2 = as.Date(str_sub(validation_rout_HSI$Injury.4, start = -10), format = '%m/%d/%Y') > Test.2)
         
#adds columns that return 'Yes' if an injury occurred after the athlete was deemed high risk and a 'No' if no injury occurred after
validation_rout_HSI <- validation_rout_HSI %>%
         mutate(Test.1.Success = ifelse(rowSums(validation_rout_HSI[, c('Injury.1.After', 'Injury.2.After', 'Injury.3.After', 'Injury.4.After')], na.rm = TRUE) > 0, 'Yes', 'No'),
         Test.2.Success = ifelse(is.na(validation_rout_HSI$Test.2), NA, ifelse(rowSums(validation_rout_HSI[, c('Injury.1.After.2', 'Injury.2.After.2', 'Injury.3.After.2', 'Injury.4.After.2')], na.rm = TRUE) > 0, 'Yes', 'No')))
```

```{r}
#combining tests and injury outcomes and creating a data frame that just contains the dates of the test results and whether an injury occurred for the athlete after these tests
tests_rout <- c(validation_rout_HSI$Test.1, validation_rout_HSI$Test.2)
outcomes_rout <- c(validation_rout_HSI$Test.1.Success, validation_rout_HSI$Test.2.Success)
tests_outcomes_rout <- data.frame(tests_rout, outcomes_rout) %>%
  na.omit

#calculating percent of the time right
mean(tests_outcomes_rout$outcomes == 'Yes')

#visualizing using a bar plot 
ggplot(tests_outcomes_rout, aes(x = outcomes_rout, fill = outcomes_rout)) + 
  geom_bar(color = 'black', show.legend = FALSE) +
  scale_fill_manual(values = c('gold2', 'grey2')) + 
  labs(title = 'Outcomes of Soft Tissue Watchlist (Routine Risk)',
       x = 'Injury Occured After Deemed Routine Risk',
       y = 'Number of Observations') + 
  theme_bw()
```

Player ID_111 injured his left hamstring less than a month after the test and right hamstring a little over a month after the test. Should have been higher risk especially with injuring his left hamstring twice before the test. Player ID_220 injured his almost 10 months after the test which is quite a lot of time. Player ID_238 also injured his almost 8 months after the test. Player ID_247 hurt his hamstring in under 2 months from the test. Player ID_420 hurt his hamstring in under 2 months from his first test similarily. Player ID_485 and ID_50 hurt his hamstring in just over a month from the test. Player ID_75 hurt his in under 4 months from the test. 




