---
title: "joint_workflow"
output: html_document
date: "2025-06-17"
---

```{r}
library(tidyverse)
library(readxl)
library(aod)
library(tidyverse)
library(tidyr)
library(dplyr)
library(ggplot2)
library(lubridate)
```

```{r}
#load all of the useful datasets
ACWR <- read.csv("~/T2P1-data-analysis-2025/data-sets/ACWR-Catapult FB.csv")
catapult <- read.csv("~/T2P1-data-analysis-2025/data-sets/Catapult Session - Outdoor FB.csv")
incident <- read.csv("~/T2P1-data-analysis-2025/data-sets/Incident Report FB.csv")
perfnorm <- read.csv("~/T2P1-data-analysis-2025/data-sets/Performance Normative Data FB.csv")
perfrisk <- read.csv("~/T2P1-data-analysis-2025/data-sets/Performance Risk Assessment FB.csv")
riskstatus <- read.csv("~/T2P1-data-analysis-2025/data-sets/Soft Tissue Risk Status Report FB.csv")
strengthtest <- read.csv("~/T2P1-data-analysis-2025/data-sets/Strength Testing Data FB.csv")
VALD <- read.csv("~/T2P1-data-analysis-2025/data-sets/VALD - Performance Test FB.csv")
wellness <- read.csv("~/T2P1-data-analysis-2025/data-sets/Wellness Report FB.csv")
```

##1.ACWR
```{r}
#refined ACWR dataset 
ACWR <- ACWR %>%
  filter(Sport=="FOOTBALL")
Acwr <- subset(ACWR,select=c("anon_id","Date","Position","Total.Player.Load","Acute.Total.Acceleration.Load.EWMA","Acceleration.Load.ACWR","Acceleration.Load.EWMA.ACWR","Player.Load.ACWR","Total.Distance.ACWR","Month","Year"))

#cut back to last 12 months (last year)
Acwr$Date <- mdy(Acwr$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)

acwr_merge <- Acwr %>%
  select(-c('Month', 'Year')) %>%
  na.omit() %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y'))

filtered_Acwr <- Acwr %>%
  filter(Date >= start_date) %>%
  na.omit() %>%
  group_by(anon_id, Month, Year, Position) %>%
  summarise(Total.Player.Load = mean(Total.Player.Load, na.rm = TRUE),
            Acceleration.Load.EWMA.ACWR = mean(Acceleration.Load.EWMA.ACWR, na.rm = TRUE),
            Acceleration.Load.ACWR = mean(Acceleration.Load.ACWR, na.rm = TRUE),
            Player.Load.ACWR = mean(Player.Load.ACWR, na.rm = TRUE),
            Acute.Total.Acceleration.Load.EWMA=mean(Acute.Total.Acceleration.Load.EWMA, na.rm=TRUE),
            Total.Distance.ACWR = mean(Total.Distance.ACWR, na.rm = TRUE)) %>%
  ungroup()
```
```{r}
min(filtered_Acwr$Date,na.rm=TRUE)
max(filtered_Acwr$Date,na.rm=TRUE)
```

```{r}
ggplot(Acwr, aes(Acceleration.Load.EWMA.ACWR)) + 
  geom_histogram(bins = 30, fill = 'royalblue', color = 'black') + 
  labs(title = 'Distribution of Total Player Load',
       x = 'Total Player Load',
       y = 'Number of Players') +
  theme_bw()

Acwr_HSI <- Acwr %>%
  filter(anon_id == 'ID_95', '2024-07-01' < Date & Date < '2024-12-01')

ggplot(Acwr_HSI, aes(Acceleration.Load.EWMA.ACWR)) + 
  geom_histogram(bins = 30, fill = 'royalblue', color = 'black') + 
  labs(title = 'Distribution of Total Player Load in Players with HSI',
       x = 'Total Player Load',
       y = 'Number of Players') +
  theme_bw()
```
## 2. Catapult 
```{r}
#refined catapult session outdoor dataset
catapult <- catapult %>%
filter(Sport=="FOOTBALL")

catapult <- subset(catapult,select=c("anon_id", "Position", "Date", "High.Speed.Distance", "Very.High.Speed.Distance", "Maximum.Velocity", "Average.Velocity","TRIMP","IMA.Accel.Low", "IMA.Decel.Low", "IMA.Accel.Medium", "IMA.Decel.Medium", "IMA.Accel.High", "IMA.Decel.High", "IMA.Accel.Total", "IMA.Decel.Total", "Explosive.Efforts","Average.IMA","Max.Acceleration","Max.Deceleration"))

catapult$Date <- mdy(catapult$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)

filtered_catapult <- catapult %>%
  filter(Date >= start_date) %>%
  group_by(anon_id, Date, Position) %>%
  summarise(High.Speed.Distance = sum(High.Speed.Distance, na.rm = TRUE),
            Very.High.Speed.Distance = sum(Very.High.Speed.Distance, na.rm = TRUE),
            Max.Acceleration= mean(Max.Acceleration,na.rm=TRUE),
            Max.Deceleration= mean(Max.Deceleration, na.rm=TRUE),
            Maximum.Velocity = mean(Maximum.Velocity, na.rm = TRUE),
            Average.Velocity = mean(Average.Velocity, na.rm = TRUE),
            Average.IMA= mean(Average.IMA, na.rm=TRUE),
            TRIMP = mean(TRIMP, na.rm=TRUE),
            IMA.Accel.Low = sum(IMA.Accel.Low, na.rm = TRUE),
            IMA.Decel.Low = sum(IMA.Decel.Low, na.rm = TRUE),
            IMA.Accel.Medium = sum(IMA.Accel.Medium, na.rm = TRUE),
            IMA.Decel.Medium = sum(IMA.Decel.Medium, na.rm = TRUE),
            IMA.Accel.High = sum(IMA.Accel.High, na.rm = TRUE),
            IMA.Decel.High = sum(IMA.Decel.High, na.rm = TRUE),
            IMA.Accel.Total = sum(IMA.Accel.Total, na.rm = TRUE),
            IMA.Decel.Total = sum(IMA.Decel.Total, na.rm = TRUE),
            Explosive.Efforts = sum(Explosive.Efforts, na.rm = TRUE))
```
```{r}
min(filtered_catapult$Date,na.rm=TRUE)
max(filtered_catapult$Date,na.rm=TRUE)
```

```{r}
#IMAs are counted variable so sum these
mean(catapult$High.Speed.Distance,na.rm=TRUE)
mean(catapult$Maximum.Velocity,na.rm=TRUE)
mean(catapult$Total.Player.Load,na.rm=TRUE)
mean(catapult$Player.Load.min,na.rm=TRUE)

#Maximum + average of the maximum & average velocity (given to us)
max(catapult$Maximum.Velocity,na.rm=TRUE)
mean(catapult$Average.Velocity,na.rm=TRUE)
```

## 3. Incident 
```{r}
incident <- read.csv("~/T2P1-data-analysis-2025/data-sets/Incident Report FB.csv")
```

```{r}
#sort out any non football values + etc
incident <- incident %>%
filter(Sport=="FOOTBALL") %>%
filter(Incident.Type=="Injury") %>%
filter(Result.of.Sport.Participation=="Yes")

filtered_incident <- subset(incident,select=c("anon_id", "Position", "Date.of.Injury...Onset.of.symptoms", "Side", "Body.Part", "Tissue.Type", "Pathology.Type", "OSICS14.Code", "OSICS10.Code", "OSICS10.Diagnosis", "Final.Diagnosis", "Result.of.Sport.Participation", "Recurrence.of.Injury", "Injury.Prognosis", "General.Mechanism", "Specific.Mechanism", "FinalDiagnosisIncidentDate", "Total.Time.Injured", "Month", "Year","Incident.Type"))[-c(1167,1168),]

#cut back to last year
filtered_incident$Date <- mdy(filtered_incident$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)
filtered_incident <- filtered_incident %>%
  filter(Date >= start_date)

#(basic) HAMSTRING INJURY BINARY TO USE AS RESPONSE VARIABLE 
#filtered_incident$HSI <- ifelse(filtered_incident$Body.Part == "Thigh",1,0)
```

```{r}
#creating a list of the lower body areas in Body.Part and for OSICS codes for HSI
lower_body <- c("Thigh", "Ankle", "Lower Leg", "Knee", "Foot", "Groin/hip")
hamstring_OSICS14 <- c('TM1', 'TMB', 'TMS', 'TR1')

#filtering the incident report to only show those deemed high risk with only lower body injuries as well as only HSI related injuries
incident_hr_all <- incident %>%
  filter(anon_id %in% high_risk, Body.Part %in% lower_body) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

incident_hr_HSI <- incident %>%
  filter(anon_id %in% high_risk, OSICS14.Code %in% hamstring_OSICS14) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')
#consolidates all injuries for these athletes into one column
incident_hr_all2 <- incident_hr_all %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))

incident_hr_HSI2 <- incident_hr_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))
```

```{r, warning = FALSE}
#filter for just hamstring related injuries and get rid of duplicate observations
incident_HSI <- filtered_incident %>%
  filter(OSICS14.Code %in% hamstring_OSICS14) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE),
         Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

#filter for just injuries in the lower body and get rid of duplicate observations
incident_lower <- filtered_incident %>%
  filter(Body.Part %in% lower_body) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE),
         Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

#creating a list of players who experienced HSI
players_HSI <- unique(incident_HSI$anon_id)

#consolidate same players into one observation
incident_HSI2 <- incident_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(Date, collapse = " and ")) %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ')
```

## 4. Performance Normative data
```{r}
filtered_perfnorm <- subset(perfnorm,select=c("anon_id","Date","Position","Nordic.Average","Nordic.Imbalance..","Adduction.Abduction.Ratio","Eccentric.Peak.Power...Relative","Jump.Height","Modified.RSI"))

#cut back to last year
filtered_perfnorm$Date <- mdy(filtered_perfnorm$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)
perfnorm_merge <- filtered_perfnorm %>%
  filter(Date >= start_date) %>%
  group_by(anon_id, Date) %>%
  select(-Position) %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()

#can compare to NFL + NBA aswell
min(filtered_perfnorm$Date,na.rm=TRUE)
max(filtered_perfnorm$Date,na.rm=TRUE)
```

## 5. Performance Risk Assessment 
DATASET ONLY FROM ONE DAY OF LAST YEAR.

```{r}
#filter football
perfrisk <- perfrisk %>%
  filter(Sport=="FOOTBALL")
#ALL variables are relevant
filtered_perfrisk <- subset(perfrisk,select=c("anon_id", "Date","Position","Hamstring.Avg..Imbalance", "L..Hamstring.Max.Force","R..Hamstring.Max.Force","L..Eccentric.Mean.Force","R..Eccentric.Mean.Force","Eccentric.Mean.Force.Asym","CMJ.Landing.Asym.","CMJ.Jump.Height","Groin.Avg..Imbalance", "Relative.Peak.Power","CMJ.Peak.Force","IMTP.Peak.Force"))

perfrisk_merge <- filtered_perfrisk %>%
  select(-Position) %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()
```

## 6. Soft Tissue Risk Status
```{r}
riskstatus <- read.csv("~/T2P1-data-analysis-2025/data-sets/Soft Tissue Risk Status Report FB.csv")
```

```{r}
#refined risk status dataset
#contains variable, what we are comparing against// validating 
riskstatus <- riskstatus[,-c(1,5)]

#cut back to last year
riskstatus$Date <- mdy(riskstatus$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)
riskstatus <- riskstatus %>%
  filter(Date >= start_date) #215 -> 100 obs.

#binary could be useful when testing accuracy/importance of high risk status
Highrisk_binary=ifelse(riskstatus$Status=="High",1,0)
#cbind(Riskstatus,Highrisk_binary)

riskstatus$Highrisk_binary = Highrisk_binary

merge_risk <- riskstatus %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y'))

min(riskstatus$Date,na.rm=TRUE)
max(riskstatus$Date,na.rm=TRUE)
```

## Validating the Soft-Tissue Watchlist
```{r}
#filtering just the high risk athletes from the watchlist
Riskstatus_high <- riskstatus %>%
  filter(Status == 'High') %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(DateRisk = paste0(Date, collapse = " and "))

#creating a list of the unique athlete ids that were deemed high risk
high_risk <- unique(Riskstatus_high$anon_id)
```


## 7. Stength Test
```{r}
#not expected to use this dataset alot + no real need to filter atm 
strengthtest <- read.csv("~/T2P1-data-analysis-2025/data-sets/Strength Testing Data FB.csv")
```

```{r}
#cut back to last year
strengthtest$Date <- mdy(strengthtest$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)
strengthtest_merge <- strengthtest %>%
  filter(Date >= start_date) %>%  # 224 -> 26 obs.
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()

min(strengthtest$Date,na.rm=TRUE)
max(strengthtest$Date,na.rm=TRUE)
```

## 8. VALD Performance Test 
```{r}
filtered_VALD <- subset(VALD, select = c("anon_id","Date", "Session.Date", "Position", "Trend", "Maximum.Force","Average.Force","Impulse", "Percent.Difference.Norm", "Nordic.Left.MAX", "Nordic.Right.MAX", "Nordic.MEAN.Imbalance.with.side", "Positional.Norm","Hip.Abd.Trend","Hip.Add.Trend", "Nordic...Difference.from.First.Test", "Month", "Year"))

#cut back to last year
filtered_VALD$Date <- mdy(filtered_VALD$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)
filtered_VALD <- filtered_VALD %>%
  filter(Date >= start_date)

vald_merge <- filtered_VALD %>%
  select(-c('Month', 'Year', 'Position')) %>%
  mutate(Date = as.Date(Session.Date, format = '%m/%d/%Y')) %>%
  na.omit()

filtered_vald <- filtered_VALD %>%
  mutate(Session.Date = as.Date(Session.Date, format = '%m/%d/%Y')) %>%
  group_by(anon_id, Month, Year, Trend) %>%
  summarise(Maximum.Force = mean(Maximum.Force, na.rm = TRUE),
            Percent.Difference.Norm = mean(Percent.Difference.Norm, na.rm = TRUE),
            Nordic.Left.MAX = mean(Nordic.Left.MAX, na.rm = TRUE),
            Nordic.Right.MAX = mean(Nordic.Right.MAX, na.rm = TRUE),
            Nordic.MEAN.Imbalance.with.side = mean(Nordic.MEAN.Imbalance.with.side, na.rm = TRUE),
            Positional.Norm = mean(Positional.Norm, na.rm = TRUE),
            Nordic...Difference.from.First.Test = mean(Nordic...Difference.from.First.Test, na.rm = TRUE)) %>%
  ungroup()

min(filtered_VALD$Date,na.rm=TRUE)
max(filtered_VALD$Date,na.rm=TRUE)
```

```{r}
ggplot(filtered_vald, aes(x = Maximum.Force)) + 
  geom_histogram(bins = 30, fill = 'royalblue', color = 'black') + 
  labs(title = 'Distribution of Nordic Maximum Force',
       x = 'Maximum Force',
       y = 'Number of Athletes') +
  theme_bw()
```

## 9. Wellness
```{r}
wellness <- read.csv("~/T2P1-data-analysis-2025/data-sets/Wellness Report FB.csv")
```

```{r}
wellness <- wellness %>%
  filter(Sport=="FOOTBALL")

#mental score, physical score,sleep quality score, soreness scores, + overall wellness all relevant 
filtered_wellness <- subset(wellness, select=c("anon_id","Date","Mental.Score","Physical.Score", "Sleep.Quality.Score","Soreness.Score","Overall.Wellness.Score","Wellness.Compliance","Month","Year"))

#cut back to last year
filtered_wellness$Date <- mdy(filtered_wellness$Date)
current_date <- Sys.Date()
start_date <- current_date- months(12)
filtered_wellness <- filtered_wellness %>%
  filter(Date >= start_date) 

Wellness_merge <- filtered_wellness %>%
  select(-c('Month', 'Year')) %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()

#omit the N/A's
filtered_wellness <- filtered_wellness %>%
  na.omit() %>%
  group_by(anon_id, Month, Year) %>%
  summarise(Mental.Score = mean(Mental.Score),
            Physical.Score = mean(Physical.Score),
            Sleep.Quality.Score = mean(Sleep.Quality.Score),
            Soreness.Score = mean(Soreness.Score),
            Overall.Wellness.Score = mean(Overall.Wellness.Score))
min(filtered_wellness$Date,na.rm=TRUE)
max(filtered_wellness$Date,na.rm=TRUE)
```

```{r}
ggplot(data = filtered_wellness, aes(x = Overall.Wellness.Score)) + 
  geom_histogram(bins = 30, color = 'black', fill = 'royalblue') +
  theme_bw()
```

## VALIDATION OF SOFT TISSUE WATCHLIST 
```{r, warning = FALSE}
#combines the dates the athletes were deemed high risk with their injuries and separates the injury occurrences and dates
validation_all <- left_join(Riskstatus_high, incident_hr_all2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4', 'Injury.5', 'Injury.6', 'Injury.7', 'Injury.8'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

#combines the above but specifically for HSI and includes T/F for whether the athlete suffered their injury after their high risk assessment
validation_HSI <- left_join(Riskstatus_high, incident_hr_HSI2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

validation_HSI <- validation_HSI %>%
  mutate(Injury.1.After = as.Date(str_sub(validation_HSI$Injury.1, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.2.After = as.Date(str_sub(validation_HSI$Injury.2, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.3.After = as.Date(str_sub(validation_HSI$Injury.3, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.4.After = as.Date(str_sub(validation_HSI$Injury.4, start = -10), format = '%m/%d/%Y') > Test.1,
         Injury.1.After.2 = as.Date(str_sub(validation_HSI$Injury.1, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.2.After.2 = as.Date(str_sub(validation_HSI$Injury.2, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.3.After.2 = as.Date(str_sub(validation_HSI$Injury.3, start = -10), format = '%m/%d/%Y') > Test.2,
         Injury.4.After.2 = as.Date(str_sub(validation_HSI$Injury.4, start = -10), format = '%m/%d/%Y') > Test.2)
         
#adds columns that return 'Yes' if an injury occurred after the athlete was deemed high risk and a 'No' if no injury occurred after
validation_HSI <- validation_HSI %>%
         mutate(Test.1.Success = ifelse(rowSums(validation_HSI[, c('Injury.1.After', 'Injury.2.After', 'Injury.3.After', 'Injury.4.After')], na.rm = TRUE) > 0, 'Yes', 'No'),
         Test.2.Success = ifelse(is.na(validation_HSI$Test.2), NA, ifelse(rowSums(validation_HSI[, c('Injury.1.After.2', 'Injury.2.After.2', 'Injury.3.After.2', 'Injury.4.After.2')], na.rm = TRUE) > 0, 'Yes', 'No')))
```

```{r}
#combining tests and injury outcomes and creating a data frame that just contains the dates of the test results and whether an injury occurred for the athlete after these tests
tests <- c(validation_HSI$Test.1, validation_HSI$Test.2)
outcomes <- c(validation_HSI$Test.1.Success, validation_HSI$Test.2.Success)
tests_outcomes <- data.frame(tests, outcomes) %>%
  na.omit

#calculating % of the time right
mean(tests_outcomes$outcomes == 'Yes')

#visualizing using a bar plot 
ggplot(tests_outcomes, aes(x = outcomes, fill = outcomes)) + 
  geom_bar(color = 'black', show.legend = FALSE) +
  scale_fill_manual(values = c('gold2', 'grey2')) + 
  labs(title = 'Outcomes of Soft Tissue Watchlist (High Risk)',
       x = 'Injury Occured After Deemed High Risk',
       y = 'Number of Observations') + 
  theme_bw()
```

# Attempting to Merge Datasets into One filtered by date
Already filtered every dataset to the past year. 
1. Creating Incident Report with Start and End Dates
```{r, warning = FALSE}
#generates a date for 6 months from the injury and then collapses the injury dates and 6 month prior dates into 8 columns (4 injuries per player) for each player 
HSI_6_months <- incident_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y'),
         start_date = Date - months(6)) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Dates.Final = paste0(Date, collapse = " and "),
            Dates.Start = paste0(start_date, collapse = " and ")) %>%
  separate(Dates.Final, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(Dates.Start, c('Injury.1.Start', 'Injury.2.Start', 'Injury.3.Start', 'Injury.4.Start'), sep = ' and ')
```

```{r}
HSI_year <- incident_HSI %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Dates.Final = paste0(Date, collapse = " and "),
            Dates.Start = paste0(start_date, collapse = " and ")) %>%
  separate(Dates.Final, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(Dates.Start, c('Injury.1.Start', 'Injury.2.Start', 'Injury.3.Start', 'Injury.4.Start'), sep = ' and ')
```

2. Merging Wellness
```{r}
#merges the HSI_6_months with wellness by anon_id
merge_well <- merge(HSI_6_months, Wellness_merge, by = c('anon_id'), all = TRUE)

merge_well <- merge_well %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

merge_well <- merge_well %>%
  group_by(anon_id, Group) %>%
  summarise(Mental.Score = mean(Mental.Score),
            Physical.Score = mean(Physical.Score),
            Sleep.Quality.Score = mean(Sleep.Quality.Score),
            Soreness.Score = mean(Soreness.Score),
            Overall.Wellness.Score = mean(Overall.Wellness.Score))
```
3. Merging VALD
```{r}
merge_vald <- merge(HSI_6_months, vald_merge, by = c('anon_id'), all = TRUE)

merge_vald <- merge_vald %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

merge_vald <- merge_vald %>%
  group_by(anon_id, Group) %>%
  summarise(Maximum.Force = mean(Maximum.Force, na.rm = TRUE),
            Percent.Difference.Norm = mean(Percent.Difference.Norm, na.rm = TRUE),
            Nordic.Left.MAX = mean(Nordic.Left.MAX, na.rm = TRUE),
            Nordic.Right.MAX = mean(Nordic.Right.MAX, na.rm = TRUE),
            Nordic.MEAN.Imbalance.with.side = mean(Nordic.MEAN.Imbalance.with.side, na.rm = TRUE),
            Positional.Norm = mean(Positional.Norm, na.rm = TRUE),
            Nordic...Difference.from.First.Test = mean(Nordic...Difference.from.First.Test, na.rm = TRUE))
```

4. Merging Catapult
```{r}
merge_catapult <- merge(HSI_6_months, filtered_catapult, by = c('anon_id'), all = TRUE)

merge_catapult <- merge_catapult %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

merge_catapult <- merge_catapult %>%
  group_by(anon_id, Group) %>%
  summarise(High.Speed.Distance = sum(High.Speed.Distance, na.rm = TRUE),
            Very.High.Speed.Distance = sum(Very.High.Speed.Distance, na.rm = TRUE),
            Maximum.Velocity = mean(Maximum.Velocity, na.rm = TRUE),
            Average.Velocity = mean(Average.Velocity, na.rm = TRUE),
            IMA.Accel.Low = sum(IMA.Accel.Low, na.rm = TRUE),
            IMA.Decel.Low = sum(IMA.Decel.Low, na.rm = TRUE),
            IMA.Accel.Medium = sum(IMA.Accel.Medium, na.rm = TRUE),
            IMA.Decel.Medium = sum(IMA.Decel.Medium, na.rm = TRUE),
            IMA.Accel.High = sum(IMA.Accel.High, na.rm = TRUE),
            IMA.Decel.High = sum(IMA.Decel.High, na.rm = TRUE),
            IMA.Accel.Total = sum(IMA.Accel.Total, na.rm = TRUE),
            IMA.Decel.Total = sum(IMA.Decel.Total, na.rm = TRUE),
            Explosive.Efforts = sum(Explosive.Efforts, na.rm = TRUE))
```

5. Merging ACWR
```{r}
merge_acwr <- merge(HSI_6_months, acwr_merge, by = c('anon_id'), all = TRUE)

merge_acwr <- merge_acwr %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

merge_acwr <- merge_acwr %>%
  group_by(anon_id, Group) %>%
  summarise(Total.Player.Load = mean(Total.Player.Load, na.rm = TRUE),
            Acceleration.Load.EWMA.ACWR = mean(Acceleration.Load.EWMA.ACWR, na.rm = TRUE),
            Acceleration.Load.ACWR = mean(Acceleration.Load.ACWR, na.rm = TRUE),
            Player.Load.ACWR = mean(Player.Load.ACWR, na.rm = TRUE),
            Total.Distance.ACWR = mean(Total.Distance.ACWR, na.rm = TRUE))
```

6. Merging Soft Tissue
```{r}
merge_risk <- merge(HSI_6_months, riskstatus, by = c('anon_id'), all = TRUE)

merge_risk <- merge_risk %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

merge_risk <- merge_risk %>%
  select(anon_id, Group, Status) %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')
```

7. Merging Perfnorm
```{r}
merge_perfnorm <- merge(HSI_6_months, perfnorm_merge, by = c('anon_id'), all = TRUE)

merge_perfnorm <- merge_perfnorm %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

merge_perfnorm <- merge_perfnorm %>%
  group_by(anon_id, Group) %>%
  summarise(Nordic.Average = mean(Nordic.Average, na.rm = TRUE),
            Nordic.Imbalance.. = mean(Nordic.Imbalance.., na.rm = TRUE),
            Adduction.Abduction.Ratio = mean(Adduction.Abduction.Ratio, na.rm = TRUE),
            Eccentric.Peak.Power...Relative = mean(Eccentric.Peak.Power...Relative, na.rm = TRUE),
            Jump.Height = mean(Jump.Height, na.rm = TRUE),
            Modified.RSI = mean(Modified.RSI, na.rm = TRUE))
```

8. Merging Strength Test
```{r}
merge_strgth <- merge(HSI_6_months, strengthtest, by = c('anon_id'), all = TRUE)

merge_strgth <- merge_strgth %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, 0)))))

merge_strgth <- merge_strgth %>%
  group_by(anon_id, Group) %>%
  summarise(Left.Quad.Force = mean(Left.Quad.Force, na.rm = TRUE),
            Right.Quad.Force = mean(Right.Quad.Force, na.rm = TRUE),
            Left.Hamstring.Force..Nordic. = mean(Left.Hamstring.Force..Nordic., na.rm = TRUE),
            Right.Hamstring.Force..Nordic. = mean(Right.Hamstring.Force..Nordic., na.rm = TRUE),
            Left.Hamstring.Quad.Ratio = mean(Left.Hamstring.Quad.Ratio, na.rm = TRUE),
            Right.Hamstring.Quad.Ratio = mean(Right.Hamstring.Quad.Ratio, na.rm = TRUE),
            Left.Hamstring.Quad.Percentage = mean(Left.Hamstring.Quad.Percentage, na.rm = TRUE),
            Right.Hamstring.Quad.Percentage = mean(Right.Hamstring.Quad.Percentage, na.rm = TRUE))
```

##Merging All Datasets Together
```{r}
#merging wellness with VALD
final_merge_full <- merge(merge_well, merge_vald, by = c('anon_id', 'Group'), all = TRUE)
#merging catapult
final_merge_full <- merge(final_merge_full, merge_catapult, by = c('anon_id', 'Group'), all = TRUE)
#merging ACWR
final_merge_full <- merge(final_merge_full, merge_acwr, by = c('anon_id', 'Group'), all = TRUE)
#merging risk status
final_merge_full <- merge(final_merge_full, merge_risk, by = c('anon_id', 'Group'), all = TRUE)
#merging performance normative data
final_merge_full <- merge(final_merge_full, merge_perfnorm, by = c('anon_id', 'Group'), all = TRUE)
#merging strength testing data, does lower number of observations in final_merge
final_merge_full <- merge(final_merge_full, merge_strgth, by = c('anon_id', 'Group'), all = TRUE)

#making a binary indicator variable HSI and ommitting the N/As
final_merge <- final_merge_full %>%
  mutate(Group = ifelse(is.na(Group), 0, Group),
         HSI = ifelse(Group > 0, 1, 0)) %>%
  select(-Group) %>%
  na.omit()
```












Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.