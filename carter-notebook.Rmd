---
title: "Carter's Notebook"
output: html_notebook
---

```{r, message = FALSE, error = FALSE}
#Authors: [Carter Zborowski]

#Author Date: 06/09/2025
#Purpose: The purpose of this notebook is to house all data set transformation, cleansing, visualization, statistical analysis, and note-taking for the 2025 CU Athletic Department Sports Science Internship Program

#LAST UPDATED: 06/25/2025

#loading in useful libraries
library(tidyverse)
library(readxl)
library(aod)
library(tidyverse)
library(tidyr)
library(dplyr)
library(ggplot2)
library(MASS)
```


# Importing and Cleaning Datasets


```{r}
#load all of the useful datasets
ACWR <- read_csv('data-sets/data-sets-uncompressed/ACWR- Catapult FB.csv')
catapult <- read_csv('data-sets/data-sets-uncompressed/Catapult Session - Outdoor FB.csv')
incident <- read_csv('data-sets/data-sets-uncompressed/Incident Report FB.csv')
perfnorm <- read_csv('data-sets/data-sets-uncompressed/Performance Normative Data FB.csv')
perfrisk <- read_csv('data-sets/data-sets-uncompressed/Performance Risk Assessment FB.csv')
riskstatus <- read_csv('data-sets/data-sets-uncompressed/Soft Tissue Risk Status Report FB.csv')
strengthtest <- read_csv('data-sets/data-sets-uncompressed/Strength Testing Data FB.csv')
VALD <- read_csv('data-sets/data-sets-uncompressed/VALD - Performance Test FB.csv')
wellness <- read_csv('data-sets/data-sets-uncompressed/Wellness Report FB.csv')
positional <- read_csv('data-sets/data-sets-uncompressed/Positional Performance Normative.csv')
```


## ACWR Dataset


```{r}
#refined ACWR dataset 
Acwr <- subset(ACWR,select=c("anon_id", "Date", "Position", "Total.Player.Load", "Acceleration.Load.EWMA.ACWR", "Acceleration.Load.ACWR", "Player.Load.ACWR", "Total.Distance.ACWR", "Month", "Year"))

#getting rid of NA values for ease and the month and year column for the merge dataset as well as converting the date to a date object in r
acwr_merge <- Acwr %>%
  select(-c('Month', 'Year')) %>%
  na.omit() %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y'))
```


## Catapult


```{r}
#refined catapult session outdoor dataset
Catapult <- subset(catapult,select=c("anon_id", "Position", "Date", "High.Speed.Distance", "Very.High.Speed.Distance", "Maximum.Velocity", "Average.Velocity", "IMA.Accel.Low", "IMA.Decel.Low", "IMA.Accel.Medium", "IMA.Decel.Medium", "IMA.Accel.High", "IMA.Decel.High", "IMA.Accel.Total", "IMA.Decel.Total", "Explosive.Efforts", "Total.Player.Load", "Average.IMA", "Max.Acceleration", "Max.Deceleration"))

#creates a second dataset where date is in the right format and all variables of interest are summarized for each athlete on each day
catapult_merge <- Catapult %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  group_by(anon_id, Date, Position) %>%
  summarise(High.Speed.Distance = sum(High.Speed.Distance, na.rm = TRUE),
            Very.High.Speed.Distance = sum(Very.High.Speed.Distance, na.rm = TRUE),
            Maximum.Velocity = mean(Maximum.Velocity, na.rm = TRUE),
            Average.Velocity = mean(Average.Velocity, na.rm = TRUE),
            IMA.Accel.Low = sum(IMA.Accel.Low, na.rm = TRUE),
            IMA.Decel.Low = sum(IMA.Decel.Low, na.rm = TRUE),
            IMA.Accel.Medium = sum(IMA.Accel.Medium, na.rm = TRUE),
            IMA.Decel.Medium = sum(IMA.Decel.Medium, na.rm = TRUE),
            IMA.Accel.High = sum(IMA.Accel.High, na.rm = TRUE),
            IMA.Decel.High = sum(IMA.Decel.High, na.rm = TRUE),
            IMA.Accel.Total = sum(IMA.Accel.Total, na.rm = TRUE),
            IMA.Decel.Total = sum(IMA.Decel.Total, na.rm = TRUE),
            Explosive.Efforts = sum(Explosive.Efforts, na.rm = TRUE),
            Total.Player.Load = sum(Total.Player.Load, na.rm = TRUE),
            Average.IMA = mean(Average.IMA, na.rm = TRUE),
            Max.Acceleration = max(Max.Acceleration, na.rm = TRUE),
            Max.Deceleration = min(Max.Deceleration, na.rm = TRUE))
```


## Incident


```{r}
#selecting the variables of interest within the incident report and getting rid of two observations that represent a conflicting diagnosis for player ID_194 who had a left hamstring strain/tear and Left Semimembranosis/tendinosis strain (grade 1 - 2) on 6/5/2024
Incident <- subset(incident,select=c("anon_id", "Position", "Date.of.Injury...Onset.of.symptoms", "Side", "Body.Part", "Tissue.Type", "Pathology.Type", "OSICS14.Code", "OSICS10.Code", "OSICS10.Diagnosis", "Final.Diagnosis", "Result.of.Sport.Participation", "Recurrence.of.Injury", "Injury.Prognosis", "General.Mechanism", "Specific.Mechanism", "FinalDiagnosisIncidentDate", "Total.Time.Injured", "Month", "Year"))[-c(1167,1168),]
```

```{r, warning = FALSE}
#creates two vectors describing injuries in the lower body and injury codes for HSI
lower_body <- c("Thigh", "Ankle", "Lower Leg", "Knee", "Foot", "Groin/hip")
hamstring_OSICS14 <- c('TM1', 'TMB', 'TMS')

#filter for just hamstring related injuries and get rid of duplicate observations and puts date in the correct format
incident_HSI <- Incident %>%
  filter(OSICS14.Code %in% hamstring_OSICS14) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE),
         Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

c <- incident_HSI %>%
  filter(Date >= as.Date('8/9/2024', format = '%m/%d/%Y') & Date <= as.Date('2/9/2025', format = '%m/%d/%Y'))

d <- merge(filtered_perfrisk, c, by = 'anon_id', all = TRUE)

#filter for just injuries in the lower body and get rid of duplicate observations and puts date in the correct format
incident_lower <- Incident %>%
  filter(Body.Part %in% lower_body) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE),
         Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

#creating a list of players who experienced HSI
players_HSI <- unique(incident_HSI$anon_id)
```


## Perfnorm


```{r}
#refined perfnorm dataset
filtered_perfnorm <- subset(perfnorm,select=c("anon_id","Date","Position","Nordic.Average","Nordic.Imbalance..","Adduction.Abduction.Ratio","Eccentric.Peak.Power...Relative","Jump.Height","Modified.RSI"))

#gets rid of position due to inconsistencies and puts date in correct format
perfnorm_merge <- filtered_perfnorm %>%
  select(-Position) %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()
```


## Perfrisk


```{r}
#refined perfrisk dataset
filtered_perfrisk <- subset(perfrisk,select=c("anon_id", "Date","Position","Hamstring.Avg..Imbalance", "L..Hamstring.Max.Force","R..Hamstring.Max.Force","L..Eccentric.Mean.Force","R..Eccentric.Mean.Force","Eccentric.Mean.Force.Asym","CMJ.Landing.Asym.","CMJ.Jump.Height", "Relative.Peak.Power","CMJ.Peak.Force"))

#gets rid of position, puts date in the correct format and omits NA values
perfrisk_merge <- filtered_perfrisk %>%
  select(-Position) %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()
```


## Risk Status


```{r}
#refined risk status dataset without notes or entry number
Riskstatus <- riskstatus[,-c(1,5)]

#puts date in the correct format
risk_merge <- Riskstatus %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y'))
```


## Strength Test


```{r}
#puts date in the correct format and omits NA values
strgth_merge <- strengthtest %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()
```


## VALD


```{r}
#selecting variables of interest
Vald <- subset(VALD, select = c("anon_id", "Session.Date", "Sport.Position", "Trend", "Maximum.Force", "Percent.Difference.Norm", "Nordic.Left.MAX", "Nordic.Right.MAX", "Nordic.MEAN.Imbalance.with.side", "Positional.Norm", "Nordic...Difference.from.First.Test", "Nordic.Left.Z.Score", "Nordic.Right.Z.Score", "Month", "Year"))

#selects variables of interest and renames Sport.Position to Position
Vald <- VALD %>%
  transmute(anon_id, Session.Date, Position = Sport.Position, Trend, Maximum.Force, Percent.Difference.Norm, Nordic.Left.MAX, Nordic.Right.MAX, Nordic.MEAN.Imbalance.with.side, Positional.Norm, Nordic...Difference.from.First.Test, Nordic.Left.Z.Score, Nordic.Right.Z.Score, Nordic.Season.Average.Left, Nordic.Season.Average.Right, Nordic.MEAN.Imbalance)

#selects only the necessary columns from positional dataset
positional2 <- positional %>%
  transmute(Position, Nordic.Average.Norm = `Nordic Average`)

#merges these two datasets and calculates the percent difference norm for the missing values
Vald <- merge(Vald, positional2, by = c('Position'), all = TRUE)

Vald <- Vald %>%
  mutate(Perc.Diff.Norm = ((Nordic.Season.Average.Left + Nordic.Season.Average.Right) / (2 * Nordic.Average.Norm) - 1) * 100)

#puts date in the right format and omits the NA values, lots of player position NAs
vald_merge <- Vald %>%
  select(-c('Nordic.Left.Z.Score', 'Nordic.Right.Z.Score', 'Percent.Difference.Norm', 'Positional.Norm')) %>%
  mutate(Date = as.Date(Session.Date, format = '%m/%d/%Y')) %>%
  na.omit()
```

```{r}
ggplot(vald_merge, aes(x = Maximum.Force)) + 
  geom_histogram(bins = 30, fill = 'royalblue', color = 'black') + 
  labs(title = 'Distribution of Nordic Maximum Force',
       x = 'Maximum Force',
       y = 'Number of Athletes') +
  theme_bw()
```


## Wellness


```{r}
#selecting only the variables of interest: important to not that this only contains data from may to december of 2024
Wellness <- subset(wellness, select = c("anon_id", "Date", "Mental.Score", "Physical.Score", "Sleep.Quality.Score", "Soreness.Score", "Overall.Wellness.Score", "Month", "Year"))

#puts date in the right format and omits the NAs
Wellness_merge <- Wellness %>%
  select(-c('Month', 'Year')) %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  na.omit()
```

```{r}
ggplot(data = Wellness_merge, aes(x = Overall.Wellness.Score)) + 
  geom_histogram(bins = 30, color = 'black', fill = 'royalblue') +
  theme_bw()
```


# Attempting to Merge Datasets into One filtered by date

Creating Incident Report with Start and End Dates

```{r, warning = FALSE}
#creates a data frame with HSI injury dates for each player that experienced HSI with start dates on last HSI date or 6 months earlier if no previous HSI
HSI_last_injury <- incident_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Dates.Final = paste0(Date, collapse = " and "),
            Mechanism = paste0(General.Mechanism, collapse = " and "),
            Recurrence = paste0(Recurrence.of.Injury, collapse = " and "),
            Time.Injured = paste0(Total.Time.Injured, collapse = " and ")) %>%
  separate(Dates.Final, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  mutate(Injury.1.Start = as.Date(Injury.1) - months(6),
         Injury.2.Start = ifelse(is.na(Injury.2), NA, Injury.1),
         Injury.3.Start = ifelse(is.na(Injury.3), NA, Injury.2),
         Injury.4.Start = ifelse(is.na(Injury.4), NA, Injury.3)) %>%
  separate(Mechanism, c('Injury.1.Mech', 'Injury.2.Mech', 'Injury.3.Mech', 'Injury.4.Mech'), sep = ' and ') %>%
  separate(Recurrence, c('Injury.1.Recur', 'Injury.2.Recur', 'Injury.3.Recur', 'Injury.4.Recur'), sep = ' and ') %>%
  separate(Time.Injured, c('Injury.1.Time', 'Injury.2.Time', 'Injury.3.Time', 'Injury.4.Time'), sep = ' and ')
```

The summarize function collapses all injury information into one row for each player, the separate function creates multiple different columns to hold this information (only did 4 columns since max amount of HSI for one player in the dataset was 4), mutate creates start dates for the injuries. 

## Merging Incident

```{r}
#trying to merge hamstring injuries with other lower body injuries
merge_incid <- merge(HSI_last_injury, incident_HSI, by = c('anon_id'), all = TRUE)

#creates a variable called Group that groups based on date within injury intervals and outputs 'After' if the date is after all injuries, and then these are omitted
merge_incid <- merge_incid %>%
  mutate(Group = case_when(
    is.na(Injury.1) | Date < Injury.1.Start ~ '0',
    !is.na(Injury.1) & Date >= Injury.1.Start & Date <= Injury.1 ~ '1',
    !is.na(Injury.2) & Date >= Injury.2.Start & Date <= Injury.2 ~ '2',
    !is.na(Injury.3) & Date >= Injury.3.Start & Date <= Injury.3 ~ '3',
    !is.na(Injury.4) & Date >= Injury.4.Start & Date <= Injury.4 ~ '4',
    TRUE ~ 'After')) %>%
  filter(Group != 'After')

#separates the mechanisms, recurrence, and time injured out
merge_incid <- merge_incid %>%
  mutate(Mechanism = ifelse(Group == 4, Injury.4.Mech, ifelse(Group == 3, Injury.3.Mech, ifelse(Group == 2, Injury.2.Mech, ifelse(Group == 1, Injury.1.Mech, NA)))),
         Recurrence = ifelse(Group == 4, Injury.4.Recur, ifelse(Group == 3, Injury.3.Recur, ifelse(Group == 2, Injury.2.Recur, ifelse(Group == 1, Injury.1.Recur, NA)))),
         Time.Injured = ifelse(Group == 4, Injury.4.Time, ifelse(Group == 3, Injury.3.Time, ifelse(Group == 2, Injury.2.Time, ifelse(Group == 1, Injury.1.Time, NA))))) %>%
  group_by(anon_id, Group, Mechanism, Recurrence, Time.Injured) %>%
  summarise(OSICS14.Code = paste0(OSICS14.Code, collapse = " and "), .groups = 'drop')
```

## Merging Wellness

```{r}
#merges the HSI_last_injury with wellness by anon_id
merge_well <- merge(HSI_last_injury, Wellness_merge, by = c('anon_id'), all = TRUE)

#creates a variable called Group that groups based on date within injury intervals and outputs 'After' if the date is after all injuries, and then these are omitted
merge_well <- merge_well %>%
  mutate(Group = case_when(
    is.na(Injury.1) | Date < Injury.1.Start ~ '0',
    !is.na(Injury.1) & Date >= Injury.1.Start & Date <= Injury.1 ~ '1',
    !is.na(Injury.2) & Date >= Injury.2.Start & Date <= Injury.2 ~ '2',
    !is.na(Injury.3) & Date >= Injury.3.Start & Date <= Injury.3 ~ '3',
    !is.na(Injury.4) & Date >= Injury.4.Start & Date <= Injury.4 ~ '4',
    TRUE ~ 'After')) %>%
  filter(Group != 'After')

#groups observations by the player id and which period the observation falls under then averages all numerical variables
merge_well <- merge_well %>%
  group_by(anon_id, Group) %>%
  summarise(Mental.Score = mean(Mental.Score),
            Physical.Score = mean(Physical.Score),
            Sleep.Quality.Score = mean(Sleep.Quality.Score),
            Soreness.Score = mean(Soreness.Score),
            Overall.Wellness.Score = mean(Overall.Wellness.Score), .groups = 'drop')
```

## Merging VALD

```{r}
merge_vald <- merge(HSI_last_injury, vald_merge, by = c('anon_id'), all = TRUE)

#creates a variable called Group that groups based on date within injury intervals and outputs 'After' if the date is after all injuries, and then these are omitted
merge_vald <- merge_vald %>%
  mutate(Trend = ifelse(Trend == 'Neutral', 0, ifelse(Trend == 'Up', 1, -1)),
         Group = case_when(
    is.na(Injury.1) | Date < Injury.1.Start ~ '0',
    !is.na(Injury.1) & Date >= Injury.1.Start & Date <= Injury.1 ~ '1',
    !is.na(Injury.2) & Date >= Injury.2.Start & Date <= Injury.2 ~ '2',
    !is.na(Injury.3) & Date >= Injury.3.Start & Date <= Injury.3 ~ '3',
    !is.na(Injury.4) & Date >= Injury.4.Start & Date <= Injury.4 ~ '4',
    TRUE ~ 'After')) %>%
  filter(Group != 'After') 

merge_vald <- merge_vald %>%
  group_by(anon_id, Group) %>%
  summarise(Maximum.Force = mean(Maximum.Force, na.rm = TRUE),
            Perc.Diff.Norm = mean(Perc.Diff.Norm, na.rm = TRUE),
            Trend = mean(Trend, na.rm = TRUE),
            Nordic.Left.MAX = mean(Nordic.Left.MAX, na.rm = TRUE),
            Nordic.Right.MAX = mean(Nordic.Right.MAX, na.rm = TRUE),
            #Nordic.Left.Z.Score = mean(Nordic.Left.Z.Score, na.rm = TRUE),
            #Nordic.Right.Z.Score = mean(Nordic.Right.Z.Score, na.rm = TRUE),
            Nordic.MEAN.Imbalance.with.side = mean(Nordic.MEAN.Imbalance.with.side, na.rm = TRUE),
            Nordic.Mean.Imbalance = mean(Nordic.MEAN.Imbalance, na.rm = TRUE),
            Nordic...Difference.from.First.Test = mean(Nordic...Difference.from.First.Test, na.rm = TRUE), .groups = 'drop')
```

## Merging Catapult

```{r, warning = FALSE}
merge_catapult <- merge(HSI_last_injury, catapult_merge, by = c('anon_id'), all = TRUE)

#creates a variable called Group that groups based on date within injury intervals and outputs 'After' if the date is after all injuries, and then these are omitted
merge_catapult <- merge_catapult %>%
  mutate(Group = case_when(
    is.na(Injury.1) | Date < Injury.1.Start ~ '0',
    !is.na(Injury.1) & Date >= Injury.1.Start & Date <= Injury.1 ~ '1',
    !is.na(Injury.2) & Date >= Injury.2.Start & Date <= Injury.2 ~ '2',
    !is.na(Injury.3) & Date >= Injury.3.Start & Date <= Injury.3 ~ '3',
    !is.na(Injury.4) & Date >= Injury.4.Start & Date <= Injury.4 ~ '4',
    TRUE ~ 'After')) %>%
  filter(Group != 'After')

merge_catapult <- merge_catapult %>%
  group_by(anon_id, Group) %>%
  summarise(High.Speed.Distance = sum(High.Speed.Distance, na.rm = TRUE),
            Very.High.Speed.Distance = sum(Very.High.Speed.Distance, na.rm = TRUE),
            Maximum.Velocity = mean(Maximum.Velocity, na.rm = TRUE),
            Average.Velocity = mean(Average.Velocity, na.rm = TRUE),
            IMA.Accel.Low = sum(IMA.Accel.Low, na.rm = TRUE),
            IMA.Decel.Low = sum(IMA.Decel.Low, na.rm = TRUE),
            IMA.Accel.Medium = sum(IMA.Accel.Medium, na.rm = TRUE),
            IMA.Decel.Medium = sum(IMA.Decel.Medium, na.rm = TRUE),
            IMA.Accel.High = sum(IMA.Accel.High, na.rm = TRUE),
            IMA.Decel.High = sum(IMA.Decel.High, na.rm = TRUE),
            IMA.Accel.Total = sum(IMA.Accel.Total, na.rm = TRUE),
            IMA.Decel.Total = sum(IMA.Decel.Total, na.rm = TRUE),
            Explosive.Efforts = sum(Explosive.Efforts, na.rm = TRUE),
            Total.Player.Load.C = mean(Total.Player.Load, na.rm = TRUE),
            Average.IMA = mean(Average.IMA, na.rm = TRUE),
            Max.Acceleration = max(Max.Acceleration, na.rm = TRUE),
            Max.Deceleration = min(Max.Deceleration, na.rm = TRUE), .groups = 'drop')
```

## Merging ACWR

```{r}
merge_acwr <- merge(HSI_last_injury, acwr_merge, by = c('anon_id'), all = TRUE)

#creates a variable called Group that groups based on date within injury intervals and outputs 'After' if the date is after all injuries, and then these are omitted
merge_acwr <- merge_acwr %>%
  mutate(Group = case_when(
    is.na(Injury.1) | Date < Injury.1.Start ~ '0',
    !is.na(Injury.1) & Date >= Injury.1.Start & Date <= Injury.1 ~ '1',
    !is.na(Injury.2) & Date >= Injury.2.Start & Date <= Injury.2 ~ '2',
    !is.na(Injury.3) & Date >= Injury.3.Start & Date <= Injury.3 ~ '3',
    !is.na(Injury.4) & Date >= Injury.4.Start & Date <= Injury.4 ~ '4',
    TRUE ~ 'After')) %>%
  filter(Group != 'After')

merge_acwr <- merge_acwr %>%
  group_by(anon_id, Group) %>%
  summarise(Total.Player.Load_A = mean(Total.Player.Load, na.rm = TRUE),
            Acceleration.Load.EWMA.ACWR = mean(Acceleration.Load.EWMA.ACWR, na.rm = TRUE),
            Acceleration.Load.ACWR = mean(Acceleration.Load.ACWR, na.rm = TRUE),
            Player.Load.ACWR = mean(Player.Load.ACWR, na.rm = TRUE),
            Total.Distance.ACWR = mean(Total.Distance.ACWR, na.rm = TRUE), .groups = 'drop')
```

## Merging Soft Tissue

```{r}
#merges the HSI dataset with the risk status dataset
merge_risk <- merge(HSI_last_injury, risk_merge, by = c('anon_id'), all = TRUE)

#creates a variable called Group that groups based on date within injury intervals and outputs 'After' if the date is after all injuries, and then these are omitted
merge_risk <- merge_risk %>%
  mutate(Group = case_when(
    is.na(Injury.1) | Date < Injury.1.Start ~ '0',
    !is.na(Injury.1) & Date >= Injury.1.Start & Date <= Injury.1 ~ '1',
    !is.na(Injury.2) & Date >= Injury.2.Start & Date <= Injury.2 ~ '2',
    !is.na(Injury.3) & Date >= Injury.3.Start & Date <= Injury.3 ~ '3',
    !is.na(Injury.4) & Date >= Injury.4.Start & Date <= Injury.4 ~ '4',
    TRUE ~ 'After')) %>%
  filter(Group != 'After')

#only selects the anon_id, Group, and Status and gets rid of duplicates
merge_risk <- merge_risk %>%
  dplyr::select(anon_id, Group, Status) %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop') %>%
  filter(!anon_id %in% c('ID_528', 'ID_529'))
```

Important to note this makes it so if a multiple tests fit into a slot for an injury only one will be counted. For example player ID_98 was deemed high risk on 2024-10-23 and  2025-02-27 and was injured 2025-03-11, which is after both test dates and only one of these observations is kept. This however also reduces down observations if more than one test were both after injuries. 'ID_528' and 'ID_529' are omitted because they have all NA values in this final merge_risk dataset and create a duplicate in final merge.

## Merging Perfnorm

```{r, }
merge_perfrisk <- merge(HSI_last_injury, perfrisk_merge, by = c('anon_id'), all = TRUE)

#creates a variable called Group that groups based on date within injury intervals and outputs 'After' if the date is after all injuries, and then these are omitted
merge_perfrisk <- merge_perfrisk %>%
  mutate(Group = case_when(
    is.na(Injury.1) | Date < Injury.1.Start ~ '0',
    !is.na(Injury.1) & Date >= Injury.1.Start & Date <= Injury.1 ~ '1',
    !is.na(Injury.2) & Date >= Injury.2.Start & Date <= Injury.2 ~ '2',
    !is.na(Injury.3) & Date >= Injury.3.Start & Date <= Injury.3 ~ '3',
    !is.na(Injury.4) & Date >= Injury.4.Start & Date <= Injury.4 ~ '4',
    TRUE ~ 'After')) %>%
  filter(Group != 'After')

merge_perfrisk <- merge_perfrisk %>%
  dplyr::select(anon_id, Hamstring.Avg..Imbalance, L..Hamstring.Max.Force, R..Hamstring.Max.Force, L..Eccentric.Mean.Force, R..Eccentric.Mean.Force, Eccentric.Mean.Force.Asym, CMJ.Landing.Asym., CMJ.Jump.Height, CMJ.Peak.Force, Group)
```

## Merging Strength Test

```{r}
merge_strgth <- merge(HSI_last_injury, strgth_merge, by = c('anon_id'), all = TRUE)

#creates a variable called Group that groups based on date within injury intervals and outputs 'After' if the date is after all injuries, and then these are omitted
merge_strgth <- merge_strgth %>%
  mutate(Group = case_when(
    is.na(Injury.1) | Date < Injury.1.Start ~ '0',
    !is.na(Injury.1) & Date >= Injury.1.Start & Date <= Injury.1 ~ '1',
    !is.na(Injury.2) & Date >= Injury.2.Start & Date <= Injury.2 ~ '2',
    !is.na(Injury.3) & Date >= Injury.3.Start & Date <= Injury.3 ~ '3',
    !is.na(Injury.4) & Date >= Injury.4.Start & Date <= Injury.4 ~ '4',
    TRUE ~ 'After')) %>%
  filter(Group != 'After')

merge_strgth <- merge_strgth %>%
  group_by(anon_id, Group) %>%
  summarise(Left.Quad.Force = mean(Left.Quad.Force, na.rm = TRUE),
            Right.Quad.Force = mean(Right.Quad.Force, na.rm = TRUE),
            Left.Hamstring.Force..Nordic. = mean(Left.Hamstring.Force..Nordic., na.rm = TRUE),
            Right.Hamstring.Force..Nordic. = mean(Right.Hamstring.Force..Nordic., na.rm = TRUE),
            Left.Hamstring.Quad.Ratio = mean(Left.Hamstring.Quad.Ratio, na.rm = TRUE),
            Right.Hamstring.Quad.Ratio = mean(Right.Hamstring.Quad.Ratio, na.rm = TRUE),
            Left.Hamstring.Quad.Percentage = mean(Left.Hamstring.Quad.Percentage, na.rm = TRUE),
            Right.Hamstring.Quad.Percentage = mean(Right.Hamstring.Quad.Percentage, na.rm = TRUE), .groups = 'drop')
```

## Merging in All other Lower Body Injuries

```{r}
#trying to merge hamstring injuries with other lower body injuries
merge_lower <- merge(HSI_last_injury, incident_lower, by = c('anon_id'), all = TRUE)

merge_lower <- merge_lower %>%
  mutate(Group = case_when(
    is.na(Injury.1) | Date < Injury.1.Start ~ '0',
    !is.na(Injury.1) & Date >= Injury.1.Start & Date < Injury.1 ~ '1',
    !is.na(Injury.2) & Date >= Injury.2.Start & Date < Injury.2 ~ '2',
    !is.na(Injury.3) & Date >= Injury.3.Start & Date < Injury.3 ~ '3',
    !is.na(Injury.4) & Date >= Injury.4.Start & Date < Injury.4 ~ '4',
    TRUE ~ 'After'),
    Prev.HSI = ifelse(OSICS14.Code %in% c('TM1', 'TMB', 'TMS', 'TR1'), 1, 0)) %>%
  filter(Group != 'After')

merge_lower <- merge_lower %>%
  group_by(anon_id, Group) %>%
  summarise(Final.Diagnosis = paste0(Final.Diagnosis, collapse = " and "),
            Prev.HSI = sum(Prev.HSI, na.rm = TRUE))
```

## Merging All Datasets Together

```{r}
final_merge_full <- merge(merge_incid, merge_risk, by = c('anon_id', 'Group'), all = TRUE)

final_merge_full <- merge(final_merge_full, merge_vald, by = c('anon_id', 'Group'), all = TRUE)
#merging catapult with VALD
final_merge_full <- merge(final_merge_full, merge_catapult, by = c('anon_id', 'Group'), all = TRUE)
#merging wellness
final_merge_full <- merge(final_merge_full, merge_well, by = c('anon_id', 'Group'), all = TRUE)
#merging ACWR
final_merge_full <- merge(final_merge_full, merge_acwr, by = c('anon_id', 'Group'), all = TRUE)

#merging strength testing data, does lower number of observations in final_merge
final_merge_full <- merge(final_merge_full, merge_strgth, by = c('anon_id', 'Group'), all = TRUE)

final_merge_full <- merge(final_merge_full, merge_perfrisk, by = c('anon_id', 'Group'), all = TRUE)

final_merge_full <- final_merge_full %>%
  mutate(HSI = as.factor(ifelse(Group > 0, 1, 0)))

#making a binary indicator variable HSI and ommitting the N/As
final_merge <- final_merge_full %>%
  mutate(Group = ifelse(is.na(Group), 0, Group),
         Mechanism = ifelse(is.na(Mechanism), 'None', Mechanism),
         Recurrence = ifelse(is.na(Recurrence), 'None', ifelse(Recurrence == 'NA' | Recurrence == 'New Injury/Illness', 'First', ifelse(Recurrence == 'First recurrence', 'Second', 'Third or more'))),
         Time.Injured = ifelse(is.na(Time.Injured), 0, Time.Injured),
         OSICS14.Code = ifelse(is.na(OSICS14.Code), 'None', OSICS14.Code),
         HSI = as.factor(ifelse(Group > 0, 1, 0)),
         Status = ifelse(is.na(Status), 'None', Status)) %>%
  select(-Group) %>%
  na.omit()

#creating a dataset similar to the one above but just data from 6 months prior to first injury
before_only <- final_merge_full %>%
  filter(Group == 1 | Group == 0) %>%
  mutate(Group = ifelse(is.na(Group), 0, Group),
         Mechanism = ifelse(is.na(Mechanism), 'None', Mechanism),
         Recurrence = ifelse(is.na(Recurrence), 'None', ifelse(Recurrence == 'NA' | Recurrence == 'New Injury/Illness', 'First', ifelse(Recurrence == 'First recurrence', 'Second', 'Third or more'))),
         Time.Injured = ifelse(is.na(Time.Injured), 0, Time.Injured),
         OSICS14.Code = ifelse(is.na(OSICS14.Code), 'None', OSICS14.Code),
         HSI = as.factor(ifelse(Group > 0, 1, 0)),
         Status = ifelse(is.na(Status), 'None', Status)) %>%
  select(-Group) %>%
  na.omit()
```

```{r}
table(final_merge_full$Status,final_merge_full$HSI)
```


### Analyzing Catapult Correlations


```{r}
ggplot(data = final_merge, aes(x = IMA.Accel.Total, y = HSI)) +
  geom_boxplot(color = 'black', fill = 'royalblue') + 
  labs(title = 'Distribution of IMA Acceleration Counts vs HSI Occurence',
       x = 'IMA Total Acceleration Counts',
       y = 'HSI Occurence') + 
  theme_bw()
```

```{r}
ggplot(data = before_only, aes(x = IMA.Accel.Total, y = HSI)) +
  geom_boxplot(color = 'black', fill = 'royalblue') + 
  labs(title = 'Distribution of IMA Acceleration Counts vs HSI Occurence for First Injury',
       x = 'IMA Total Acceleration Counts',
       y = 'HSI Occurence') + 
  theme_bw()
```

Decent:
Explosive.Efforts, IMA.Accel.Total, High.Speed.Distance

Eh:
Max.Acceleration, Max Deceleration

```{r}
table(final_merge$HSI, final_merge$Status)
```

```{r}
model_status <- glm(HSI ~ IMA.Accel.Total + Explosive.Efforts, data = final_merge, family = 'binomial')

summary(model_status)
```


### Analyzing Wellness Correlations


```{r}
ggplot(data = final_merge, aes(x = Overall.Wellness.Score, y = HSI)) +
  geom_boxplot(color = 'black', fill = 'royalblue') + 
  labs(title = 'Distribution of Overall Wellness Score vs HSI Occurence',
       x = 'Overall Wellness Score',
       y = 'HSI Occurence') + 
  theme_bw()
```

Does not appear to be very many correlations between wellness data and HSI occurence (at least not when averaged over the periods)


### Analyzing Strengthtesting Data


```{r}
ggplot(data = final_merge, aes(x = Right.Hamstring.Quad.Ratio, y = HSI)) +
  geom_boxplot(color = 'black', fill = 'royalblue') + 
  labs(title = 'Distribution of IMA Acceleration Counts vs HSI Occurence',
       x = 'IMA Total Acceleration Counts',
       y = 'HSI Occurence') + 
  theme_bw()
```

Could be weak correlation for H/Q ratio with the median Left/Right H/Q ratio being higher in those that experienced HSI.


### Analyzing Perfrisk Data


```{r}
ggplot(data = final_merge, aes(x = Hamstring.Avg..Imbalance, y = HSI)) +
  geom_boxplot(color = 'black', fill = 'royalblue') + 
  labs(title = 'Distribution of IMA Acceleration Counts vs HSI Occurence',
       x = 'IMA Total Acceleration Counts',
       y = 'HSI Occurence') + 
  theme_bw()
```

Does not appear to be any valuable correlations in the perfrisk data. 


# Dashboard Recreation (Question 2)


```{r}
#merges the incident report and risk status by group (period of time) and player id
dash <- merge(merge_incid, merge_risk, by = c('anon_id', 'Group'), all = TRUE)

#merges the vald dataset by the same columns
dash <- merge(dash, merge_vald, by = c('anon_id', 'Group'), all = TRUE)

#merges the lower body injuries and a column for if a different HSI occurred (same leg or different leg) before the possible injury
dash <- merge(dash, merge_lower, by = c('anon_id', 'Group'), all = TRUE)

#fills in most of the NAs with character stings and converts HSI to a binary indicator variable. Also selects just the variables within the soft tissue watch list as well as the previous HSI variable
dash <- dash %>%
  mutate(Group = ifelse(is.na(Group), 0, Group),
         Mechanism = ifelse(is.na(Mechanism), 'None', Mechanism),
         Prev.Injuries = ifelse(is.na(Final.Diagnosis), 'None', Final.Diagnosis),
         Time.Injured = ifelse(is.na(Time.Injured), 0, Time.Injured),
         OSICS14.Code = ifelse(is.na(OSICS14.Code), 'None', OSICS14.Code),
         HSI = ifelse(Group > 0, 1, 0),
         Prev.HSI = ifelse(is.na(Prev.HSI), 0, Prev.HSI),
         Status = as.factor(ifelse(is.na(Status), 'None', Status))) %>%
  dplyr::select(anon_id, Prev.Injuries, Prev.HSI, Perc.Diff.Norm, Nordic.Mean.Imbalance, Trend, Status, HSI) %>%
  mutate(Prev.Injury.Num = ifelse(Prev.Injuries == 'None', 0, sapply(strsplit(Prev.Injuries, " and "), length)))

#recreating the dataset without NAs for visualizations, should contain 178 observations
dash_final <- dash %>%
  na.omit() %>%
  mutate(Status = factor(Status, ordered=TRUE, levels = c("None", "Routine", "Low", "Medium", "High")))

#filtering for just the high risk evaluations
dash_high <- dash_final %>%
  filter(Status == 'High')

#filtering for just the low risk evaluations
dash_low <- dash_final %>%
  filter(Status == 'Low')
```

```{r}
dash_final %>%
  group_by(Status) %>%
  summarize(Avg.Perc.Diff.Norm = mean(Perc.Diff.Norm),
            Avg.Imbalance = mean(Nordic.Mean.Imbalance),
            Avg.Trend = mean(Trend),
            Previous.HSI = mean(as.numeric(Prev.HSI)),
            HSI.Occured = mean(HSI))
```

From this summary it almost looks like players are deemed medium risk when there is no previous HSI but the other variables look alarming. Players deemed low risk on average have similar differences from norm but lower imbalance and higher trend and only one observation with a previous injury. 

There are often relatively large changes in the imbalance numbers of a player when comparing the number from HSI and when they are following a previous HSI. This makes intiutive sense but important to note it could go either way, decreasing the imbalance or increasing the imbalance depending on which side was injured. 

ID_111 was deemed low risk on 8/6/2024 with the note of 'Overall weakness', then suffered HSI in left hamstring on 12/19/2024 and 01/24/2025. Then he was deemed routine risk on 2/27/2025 and suffered another HSI in left hamstring on 03/13/2025, then suffered HSI in his right hamstring on 04/01/2025. Why was he not given high risk on 2/27/2025?
There is only VALD data prior to one injury and from before 6 months before first HSI. In between these times his percent difference from norm increased from -28.7810384 to -20.5366817 and imbalance increased from 3.6 to 4.6. While these are averaged values from possible many observations there is not a significant difference between these values and in percent difference from norm he actually got stronger (better). 

ID_117 was deemed low risk on 08/06/2024 and suffered HSI in right hamstring on 02/03/2025. He had a previous HSI and two other lower body injuries, -19.1408103 percent difference from norm, greatly increased imbalance of 16.65 and positive strength trend. 

ID_247 was deemed routine risk on 02/27/2025 and suffered HSI in right hamstring on 04/08/2025. No previous HSI or lower body injuries, -20.2436195 percent difference from norm, very little imbalance, and neutral strength trend. 

ID_430 was deemed routine risk on 06/27/2024 and suffered HSI in right hamstring on  08/13/2024. No previous HSI or lower body injuries, very little percent difference from norm, very little imbalance, and nuetral strength trend.

ID_50 was deemed routine risk on 06/27/2024 and suffered HSI in left hamstring on 07/28/2024. No previous HSI or lower body injuries, 15.4972015 percent difference from norm, very little imbalance, and also nuetral strength trend.

ID_485 (Tendon Injury) was deemed routine risk on 08/06/2024 and hurt hamstring tendon on 9/14/2024. Had a previous knee injury, 12.4102612 percent difference from norm, 9.36 mean imbalance and slightly positive strength trend.

ID_75 was deemed routine risk on 06/27/2024 and suffered HSI in right hamstring on 10/12/2024. He had a previous HSI and a right quadriceps injury, 34.3498134 percent difference from norm, 9.05 mean imbalance and slightly negative strength trend. 

```{r}
#creates a boxplot comparing number of previous lower body injuries in those that experienced HSI versus those that didn't
ggplot(data = dash_final, aes(x = Prev.Injury.Num, y = as.factor(HSI))) + 
  geom_boxplot(color = 'black', fill = 'royalblue') + 
  labs(title = 'Distribution of Previous HSI vs Future HSI Occurence',
       y = 'Observations',
       x = 'Number of Previous HSI') +
  theme_bw()
```

This plot is completely biased by the fact that observations are only in there if the player sufferred HSI. 

```{r}
#creates a boxplot comparing perfentage difference from normal strength level in those that experienced HSI versus those that didn't
ggplot(data = dash_final, aes(x = Perc.Diff.Norm, y = as.factor(HSI))) + 
  geom_boxplot(color = 'black', fill = 'royalblue') + 
  labs(title = 'Distribution of Percentage Difference from Norm vs Future HSI Occurence',
       y = 'HSI Occurence',
       x = 'Percentage Difference from Norm') +
  theme_bw()
```

The median percent difference from norm for those who suffered HSI is less than the median percent difference from norm for those that did not suffer HSI. At least 75 % of the observations that suffered HSI were below the norm for strength

```{r}
#creates a boxplot comparing average nordic imbalance between legs in those that experienced HSI versus those that didn't
ggplot(data = dash_final, aes(x = Nordic.Mean.Imbalance, y = as.factor(HSI))) + 
  geom_boxplot(color = 'black', fill = 'royalblue') + 
  labs(title = 'Distribution of Mean Imbalance vs Future HSI Occurence',
       y = 'HSI Occurence',
       x = 'Nordic Mean Imbalance Between Legs') +
  theme_bw()
```

The median for average imbalance from those who experienced HSI is slightly higher than those that did not suffer HSI and has a greater IQR. 

```{r}
#creates a boxplot comparing overall strength trend in those that experienced HSI versus those that didn't
ggplot(data = dash_final, aes(x = Trend, y = as.factor(HSI))) + 
  geom_boxplot(color = 'black', fill = 'royalblue') + 
  labs(title = 'Distribution of Strength Trend vs Future HSI Occurence',
       y = 'HSI Occurence',
       x = 'Strength Trend') +
  theme_bw()
```

The trend is very commonly 0, or neutral in those that experienced HSI with only outliers being above or below 0 which is very strange. Most of the observations that did not experience HSI are 0 or greater than 0.

```{r}
#table displaying frequencies of HSI within the statuses
table(dash_final$HSI, dash_final$Status)
```

```{r}
#creates a model predicting HSI occurence from the variables in the dashboard
model <- glm(HSI ~ Prev.HSI + Perc.Diff.Norm + Nordic.Mean.Imbalance + Trend, 
             data = dash_final, family = 'binomial')

summary(model)
```

Previous hamstring related injury is a good predictor, also mentioned in literature review I beleive. Of the 57 players that experienced HSI in this dataset, 20 of those injuries came after a previous hamstring related injury. This means in the data provided, around 35.09% of the HSI came following a hamstring related injury (same or different leg).


## 3 Months Prior Emphasis from Blake


```{r, warning = FALSE}
#generates a date for 3 months from the injury and then collapses the injury dates and 3 month prior dates into 8 columns (4 injuries per player) for each player 
HSI_3_months <- incident_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y'),
         start_date = Date - months(3)) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Dates.Final = paste0(Date, collapse = " and "),
            Dates.Start = paste0(start_date, collapse = " and "),
            Mechanism = paste0(General.Mechanism, collapse = " and "),
            Recurrence = paste0(Recurrence.of.Injury, collapse = " and "),
            Time.Injured = paste0(Total.Time.Injured, collapse = " and ")) %>%
  separate(Dates.Final, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(Dates.Start, c('Injury.1.Start', 'Injury.2.Start', 'Injury.3.Start', 'Injury.4.Start'), sep = ' and ') %>%
  separate(Mechanism, c('Injury.1.Mech', 'Injury.2.Mech', 'Injury.3.Mech', 'Injury.4.Mech'), sep = ' and ') %>%
  separate(Recurrence, c('Injury.1.Recur', 'Injury.2.Recur', 'Injury.3.Recur', 'Injury.4.Recur'), sep = ' and ') %>%
  separate(Time.Injured, c('Injury.1.Time', 'Injury.2.Time', 'Injury.3.Time', 'Injury.4.Time'), sep = ' and ')
```

2. Merging VALD

```{r}
merge_vald <- merge(HSI_3_months, vald_merge, by = c('anon_id'), all = TRUE)

merge_vald <- merge_vald %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, ifelse(Date > Injury.4, 'After', 0)))))) %>%
  filter(is.na(Group) | Group != 'After')

merge_vald <- merge_vald %>%
  group_by(anon_id, Group, Position) %>%
  summarise(Maximum.Force = mean(Maximum.Force, na.rm = TRUE),
            Perc.Diff.Norm = mean(Perc.Diff.Norm, na.rm = TRUE),
            Nordic.Left.MAX = mean(Nordic.Left.MAX, na.rm = TRUE),
            Nordic.Right.MAX = mean(Nordic.Right.MAX, na.rm = TRUE),
            Nordic.MEAN.Imbalance.with.side = mean(Nordic.MEAN.Imbalance.with.side, na.rm = TRUE),
            Nordic...Difference.from.First.Test = mean(Nordic...Difference.from.First.Test, na.rm = TRUE))
```

```{r}
#trying to merge hamstring injuries with other lower body injuries
merge_lower <- merge(HSI_3_months, incident_lower, by = c('anon_id'), all = TRUE)

merge_lower <- merge_lower %>%
  mutate(Group = ifelse(Injury.1.Start <= Date & Date <= Injury.1, 1, ifelse(Injury.2.Start <= Date & Date <= Injury.2, 2, ifelse(Injury.3.Start <= Date & Date <= Injury.3, 3, ifelse(Injury.4.Start <= Date & Date <= Injury.4, 4, ifelse(Date > Injury.4, 'After', 0)))))) %>%
  filter(is.na(Group) | Group != 'After')

merge_lower <- merge_lower %>%
  mutate(Mechanism = ifelse(Group == 4, Injury.4.Mech, ifelse(Group == 3, Injury.3.Mech, ifelse(Group == 2, Injury.2.Mech, ifelse(Group == 1, Injury.1.Mech, NA)))),
         Recurrence = ifelse(Group == 4, Injury.4.Recur, ifelse(Group == 3, Injury.3.Recur, ifelse(Group == 2, Injury.2.Recur, ifelse(Group == 1, Injury.1.Recur, NA)))),
         Time.Injured = ifelse(Group == 4, Injury.4.Time, ifelse(Group == 3, Injury.3.Time, ifelse(Group == 2, Injury.2.Time, ifelse(Group == 1, Injury.1.Time, NA))))) %>%
  group_by(anon_id, Group, Mechanism, Recurrence, Time.Injured) %>%
  summarise(OSICS14.Code = paste0(OSICS14.Code, collapse = " and ")) %>%
  mutate(Injuries.Last.3.Months = ifelse(is.na(Group) | Group == 0, sapply(strsplit(OSICS14.Code, " and "), length), sapply(strsplit(OSICS14.Code, " and "), length) - 1))
```

```{r}
full_merge <- merge(merge_lower, merge_vald, by = c('anon_id', 'Group'), all = TRUE)

filtered_merge <- full_merge %>%
  mutate(Group = ifelse(is.na(Group), 0, Group),
         Mechanism = ifelse(is.na(Mechanism), 'None', Mechanism),
         Recurrence = ifelse(is.na(Recurrence), 'None', Recurrence),
         Time.Injured = ifelse(is.na(Time.Injured), 0, Time.Injured),
         OSICS14.Code = ifelse(is.na(OSICS14.Code), 'None', OSICS14.Code),
         HSI = as.factor(ifelse(Group > 0, 1, 0)),
         Imbalance = abs(Nordic.MEAN.Imbalance.with.side)) %>%
  dplyr::select(-Group) %>%
  na.omit()
```

```{r}
ggplot(filtered_merge, aes(x = Percent.Difference.Norm, y = HSI)) + 
  geom_boxplot(color = 'black', fill = 'royalblue') +
  labs(title = 'Percent Difference from Norm vs HSI Occurence',
       y = 'HSI Occurence',
       x = 'Percent Difference from Norm') + 
  theme_bw()
```

```{r}
ggplot(filtered_merge, aes(x = Imbalance, y = HSI)) + 
  geom_boxplot(color = 'black', fill = 'royalblue') +
  labs(title = 'Nordic Mean Imbalance vs HSI Occurence',
       y = 'HSI Occurence',
       x = 'Nordic Mean Imbalance (Absolute Value)') + 
  theme_bw()
```

```{r}
ggplot(filtered_merge, aes(x = Nordic...Difference.from.First.Test, y = HSI)) + 
  geom_boxplot(color = 'black', fill = 'royalblue') +
  labs(title = 'Nordic Mean Imbalance vs HSI Occurence',
       y = 'HSI Occurence',
       x = 'Nordic Mean Imbalance (Absolute Value)') + 
  theme_bw()
```


# Validating the Soft-Tissue Watchlist (Question 1)

Takes a slightly different approach to above by classifying injuries based on the dates of the tests rather than classifying the tests based on the timeline of the injuries above. 

## Players Deemed High Risk

```{r}
#filtering just the high risk athletes from the watchlist
Riskstatus_high <- Riskstatus %>%
  filter(Status == 'High') %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(DateRisk = paste0(Date, collapse = " and "))

#creating a list of the unique athlete ids that were deemed high risk
high_risk <- unique(Riskstatus_high$anon_id)
```

```{r}
#creating a list of the lower body areas in Body.Part and for OSICS codes for HSI
lower_body <- c("Thigh", "Ankle", "Lower Leg", "Knee", "Foot", "Groin/hip")
hamstring_OSICS14 <- c('TM1', 'TMB', 'TMS')

#filtering the incident report to only show those deemed high risk with only lower body injuries as well as only HSI related injuries
incident_hr_all <- Incident %>%
  filter(anon_id %in% high_risk, Body.Part %in% lower_body) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

incident_hr_HSI <- Incident %>%
  filter(anon_id %in% high_risk, OSICS14.Code %in% hamstring_OSICS14) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

#consolidates all injuries for these athletes into one column
incident_hr_all2 <- incident_hr_all %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))

incident_hr_HSI2 <- incident_hr_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))
```

Player ID_194 has a duplicate injury with both 'Left Hamstring strain/tear' and 'Left Semimembranosis/tendinosis strain (grade 1 - 2)' being listed for 06/05/24.  

```{r, warning = FALSE}
#combines the dates the athletes were deemed high risk with their injuries and separates the injury occurrences and dates
validation_hr_all <- left_join(Riskstatus_high, incident_hr_all2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4', 'Injury.5', 'Injury.6', 'Injury.7', 'Injury.8'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

#combines the above but specifically for HSI and includes T/F for whether the athlete suffered their injury after their high risk assessment
validation_hr_HSI <- left_join(Riskstatus_high, incident_hr_HSI2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

validation_hr_HSI <- validation_hr_HSI %>%
  mutate(Injury.1.After = as.Date(str_sub(validation_hr_HSI$Injury.1, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.2.After = as.Date(str_sub(validation_hr_HSI$Injury.2, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.3.After = as.Date(str_sub(validation_hr_HSI$Injury.3, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.4.After = as.Date(str_sub(validation_hr_HSI$Injury.4, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.1.After.2 = as.Date(str_sub(validation_hr_HSI$Injury.1, start = -10), format = '%m/%d/%Y') - as.Date(Test.2),
         Injury.2.After.2 = as.Date(str_sub(validation_hr_HSI$Injury.2, start = -10), format = '%m/%d/%Y') - as.Date(Test.2),
         Injury.3.After.2 = as.Date(str_sub(validation_hr_HSI$Injury.3, start = -10), format = '%m/%d/%Y') - as.Date(Test.2),
         Injury.4.After.2 = as.Date(str_sub(validation_hr_HSI$Injury.4, start = -10), format = '%m/%d/%Y') - as.Date(Test.2))
         
#adds columns that return 'Yes' if an injury occurred after the athlete was deemed high risk and a 'No' if no injury occurred after
validation_hr_HSI <- validation_hr_HSI %>%
         mutate(Test.1.Success = ifelse(is.na(Test.1), NA, ifelse(rowSums((select(., Injury.1.After:Injury.4.After) > 0), na.rm = TRUE) > 0, 'Yes', 'No')),
         Test.2.Success = ifelse(is.na(Test.2), NA, ifelse(rowSums((select(., Injury.1.After.2:Injury.4.After.2) > 0), na.rm = TRUE) > 0, 'Yes', 'No')))
```

Injury.1.After = ifelse(!is.na(Injury.1) & !is.na(Test.1), as.Date(str_sub(validation_hr_HSI$Injury.1, start = -10), format = '%m/%d/%Y') - as.Date(Test.1), NA)

### Visualizations

```{r}
#combining tests and injury outcomes and creating a data frame that just contains the dates of the test results and whether an injury occurred for the athlete after these tests
tests_hr <- c(validation_hr_HSI$Test.1, validation_hr_HSI$Test.2)
outcomes_hr <- c(validation_hr_HSI$Test.1.Success, validation_hr_HSI$Test.2.Success)
tests_outcomes_hr <- data.frame(tests_hr, outcomes_hr) %>%
  na.omit

#calculating percent of the time right
mean(tests_outcomes_hr$outcomes == 'Yes')

#visualizing using a bar plot 
ggplot(tests_outcomes_hr, aes(x = outcomes_hr, fill = outcomes_hr)) + 
  geom_bar(color = 'black', show.legend = FALSE) +
  scale_fill_manual(values = c('gold2', 'grey2')) + 
  labs(title = 'Outcomes of Soft Tissue Watchlist (High Risk)',
       x = 'Injury Occured After Deemed High Risk',
       y = 'Number of Observations') + 
  theme_bw()
```

In only 21.95122 % of the tests deeming players high risk did a HSI injury occur following. However 19 of these tests were done on 02/27/25 or later and the incident report only goes until April 22, 2025 so there could have been more injuries that occured afterwards unkown to us.  

```{r}
#vectorizes all of the columns containing time from test to injury
all_times <- c(validation_hr_HSI$Injury.1.After, validation_hr_HSI$Injury.2.After, validation_hr_HSI$Injury.3.After, validation_hr_HSI$Injury.4.After, validation_hr_HSI$Injury.1.After.2, validation_hr_HSI$Injury.2.After.2, validation_hr_HSI$Injury.3.After.2, validation_hr_HSI$Injury.4.After.2)

#vectorizes the player ids associated with the times
ids <- c(validation_hr_HSI$anon_id)

#puts the two above vectors into a data frame
length_time <- data.frame(all_times, ids)

#omitting the negative lengths of time and 0 (assuming test was after injury on the same day)
length_time <- length_time %>%
  na.omit() %>%
  mutate(anon_id = ids,
         Test.to.HSI = as.numeric(all_times)) %>%
  select(-c(all_times, ids)) %>%
  filter(Test.to.HSI > 0)

length_time1 <- length_time[-c(4, 7),]

#calculating percent of the time right
mean(length_time1$Test.to.HSI)

#visualizing using a bar plot 
ggplot(length_time, aes(x = Test.to.HSI)) + 
  geom_dotplot(color = 'black', fill = 'royalblue', binwidth = 7.5) +
  labs(title = 'Time from Test to HSI (High Risk)',
       x = 'Days After being Deemed High Risk',
       y = 'Number of Observations') + 
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) 
```

In this plot it is important to note that two of the dots represent second injuries to the same player that also occured after being deemed high risk on the watchlist. This is ID_95 with an injury coming 34 days after and then 83 days after. It is also ID_85 with an injury coming 21 days after and then 216 days after. Player ID_98 also has a kind of duplicate entry since his second injury occurred after both of his tests so he accounts for a dot at 139 and 12 days.

Consider why flagged and if they suffered another injury, 6 months

Players ID_220 and ID_83 was deemed high risk on the same day they suffered a hamstring injury, I classified them into the not accurate category. Player ID_307 suffered a tendon injury (not strain/tear) after over 3 months from the test. Player_ID 32 suffered his injury in just over 2 months. Player ID_83 suffered his injury in just under 8 months from the first test. Player ID_85 had injuries after both tests, with the first coming within the month of the test and second coming within the month of the second test. Player ID_86 and ID_87 injured their hamstrings in just under 6 months from their first tests. Player ID_95 injured his hamstring once after just over a month and a second time after under 3 months from the same test. Player ID_98 suffered a single injury after both of his tests, it being under 5 months from the first test and within a month from the second.  

Statistics:
* 9 of the 41 times a player was deemed "High" risk the player experienced HSI afterwards
* Player ID_95 experienced HSI twice after being deemed "High" risk, 34 and 83 days after
* Player ID_220 and ID_83 were deemed high risk on the same day they suffered HSI
* Incident report goes from August 29, 2023 to April 22, 2025
* Soft-Tissue Watchlist goes from June 27, 2024 to April 23, 2025. This means some classifications cannot be verified as not enough time has passed
* Average time to HSI from being deemed "High" risk in cases of success is 92.66667 days
* Player ID_83 had the longest time of 232 days
* Player ID_85 and ID_98 had the shortest, experienceing HSI only 12 days after

## Players Deemed Low Risk

```{r}
#filtering just the low risk athletes from the watchlist
Riskstatus_low <- Riskstatus %>%
  filter(Status == 'Low') %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(DateRisk = paste0(Date, collapse = " and "))

#creating a list of the unique athlete ids that were deemed high risk
low_risk <- unique(Riskstatus_low$anon_id)
```

```{r}
#filtering the incident report to only show those deemed low risk with only lower body injuries as well as only HSI related injuries
incident_lr_all <- Incident %>%
  filter(anon_id %in% low_risk, Body.Part %in% lower_body) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

incident_lr_HSI <- Incident %>%
  filter(anon_id %in% low_risk, OSICS14.Code %in% hamstring_OSICS14) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

#consolidates all injuries for these athletes into one column
incident_lr_all2 <- incident_lr_all %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))

incident_lr_HSI2 <- incident_lr_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))
```

Player ID_194 has a duplicate injury with both 'Left Hamstring strain/tear' and 'Left Semimembranosis/tendinosis strain (grade 1 - 2)' being listed for 06/05/24. Player ID_360 has a duplicate injury with both 'Left Ankle sprains' and 'Left Peroneal tendinopathy' being listed for 11/21/24, but this is less important as it only relates to ankles.

```{r, warning = FALSE}
#combines the dates the athletes were deemed high risk with their injuries and separates the injury occurrences and dates
validation_lr_all <- left_join(Riskstatus_low, incident_lr_all2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4', 'Injury.5', 'Injury.6', 'Injury.7', 'Injury.8'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

#combines the above but specifically for HSI and includes T/F for whether the athlete suffered their injury after their high risk assessment
validation_lr_HSI <- left_join(Riskstatus_low, incident_lr_HSI2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

validation_lr_HSI <- validation_lr_HSI %>%
  mutate(Injury.1.After = as.Date(str_sub(validation_lr_HSI$Injury.1, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.2.After = as.Date(str_sub(validation_lr_HSI$Injury.2, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.3.After = as.Date(str_sub(validation_lr_HSI$Injury.3, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.4.After = as.Date(str_sub(validation_lr_HSI$Injury.4, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.1.After.2 = as.Date(str_sub(validation_lr_HSI$Injury.1, start = -10), format = '%m/%d/%Y') - as.Date(Test.2),
         Injury.2.After.2 = as.Date(str_sub(validation_lr_HSI$Injury.2, start = -10), format = '%m/%d/%Y') - as.Date(Test.2),
         Injury.3.After.2 = as.Date(str_sub(validation_lr_HSI$Injury.3, start = -10), format = '%m/%d/%Y') - as.Date(Test.2),
         Injury.4.After.2 = as.Date(str_sub(validation_lr_HSI$Injury.4, start = -10), format = '%m/%d/%Y') - as.Date(Test.2))
         
#adds columns that return 'Yes' if an injury occurred after the athlete was deemed high risk and a 'No' if no injury occurred after
validation_lr_HSI <- validation_lr_HSI %>%
         mutate(Test.1.Success = ifelse(is.na(Test.1), NA, ifelse(rowSums((select(., Injury.1.After:Injury.4.After) > 0), na.rm = TRUE) > 0, 'Yes', 'No')),
         Test.2.Success = ifelse(is.na(Test.2), NA, ifelse(rowSums((select(., Injury.1.After.2:Injury.4.After.2) > 0), na.rm = TRUE) > 0, 'Yes', 'No')))
```

### Visualizations

```{r}
#combining tests and injury outcomes and creating a data frame that just contains the dates of the test results and whether an injury occurred for the athlete after these tests
tests_lr <- c(validation_lr_HSI$Test.1, validation_lr_HSI$Test.2)
outcomes_lr <- c(validation_lr_HSI$Test.1.Success, validation_lr_HSI$Test.2.Success)
tests_outcomes_lr <- data.frame(tests_lr, outcomes_lr) %>%
  na.omit

#calculating percent of the time right
mean(tests_outcomes_lr$outcomes == 'Yes')

#visualizing using a bar plot 
ggplot(tests_outcomes_lr, aes(x = outcomes_lr, fill = outcomes_lr)) + 
  geom_bar(color = 'black', show.legend = FALSE) +
  scale_fill_manual(values = c('gold2', 'grey2')) + 
  labs(title = 'Outcomes of Soft Tissue Watchlist (Low Risk)',
       x = 'Injury Occured After Deemed Low Risk',
       y = 'Number of Observations') + 
  theme_bw()
```

Important to note that only two hamstring injuries occured in players deemed low risk with one occuring almost 6 months after being deemed low risk. Player ID_111 hurt his hamstring 135, 171, 219, and 238 days after being deemed low risk.  

## Players Deemed Medium Risk

```{r}
#filtering just the low risk athletes from the watchlist
Riskstatus_med <- Riskstatus %>%
  filter(Status == 'Medium') %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(DateRisk = paste0(Date, collapse = " and "))

#creating a list of the unique athlete ids that were deemed high risk
med_risk <- unique(Riskstatus_med$anon_id)
```

```{r}
#filtering the incident report to only show those deemed low risk with only lower body injuries as well as only HSI related injuries
incident_med_all <- Incident %>%
  filter(anon_id %in% med_risk, Body.Part %in% lower_body) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

incident_med_HSI <- Incident %>%
  filter(anon_id %in% med_risk, OSICS14.Code %in% hamstring_OSICS14) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

#consolidates all injuries for these athletes into one column
incident_med_all2 <- incident_med_all %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))

incident_med_HSI2 <- incident_med_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))
```

Player ID_489 has a duplicate injury with both 'Left Knee medial collateral ligament injury' and 'Left Grade 2 MCL tear knee' being listed for 11/23/24, but this is not as important to us. Player ID_595 has a duplicate injury of 'Left Ankle sprains' on 08/15/24. 

```{r, warning = FALSE}
#combines the dates the athletes were deemed high risk with their injuries and separates the injury occurrences and dates
validation_med_all <- left_join(Riskstatus_med, incident_med_all2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4', 'Injury.5', 'Injury.6', 'Injury.7', 'Injury.8'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

#combines the above but specifically for HSI and includes T/F for whether the athlete suffered their injury after their high risk assessment
validation_med_HSI <- left_join(Riskstatus_med, incident_med_HSI2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

validation_med_HSI <- validation_med_HSI %>%
  mutate(Injury.1.After = as.Date(str_sub(validation_med_HSI$Injury.1, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.2.After = as.Date(str_sub(validation_med_HSI$Injury.2, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.3.After = as.Date(str_sub(validation_med_HSI$Injury.3, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.4.After = as.Date(str_sub(validation_med_HSI$Injury.4, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.1.After.2 = as.Date(str_sub(validation_med_HSI$Injury.1, start = -10), format = '%m/%d/%Y') - as.Date(Test.2),
         Injury.2.After.2 = as.Date(str_sub(validation_med_HSI$Injury.2, start = -10), format = '%m/%d/%Y') - as.Date(Test.2),
         Injury.3.After.2 = as.Date(str_sub(validation_med_HSI$Injury.3, start = -10), format = '%m/%d/%Y') - as.Date(Test.2),
         Injury.4.After.2 = as.Date(str_sub(validation_med_HSI$Injury.4, start = -10), format = '%m/%d/%Y') - as.Date(Test.2))
         
#adds columns that return 'Yes' if an injury occurred after the athlete was deemed high risk and a 'No' if no injury occurred after
validation_med_HSI <- validation_med_HSI %>%
         mutate(Test.1.Success = ifelse(is.na(Test.1), NA, ifelse(rowSums((select(., Injury.1.After:Injury.4.After) > 0), na.rm = TRUE) > 0, 'Yes', 'No')),
         Test.2.Success = ifelse(is.na(Test.2), NA, ifelse(rowSums((select(., Injury.1.After.2:Injury.4.After.2) > 0), na.rm = TRUE) > 0, 'Yes', 'No')))
```

### Visualizations

```{r}
#combining tests and injury outcomes and creating a data frame that just contains the dates of the test results and whether an injury occurred for the athlete after these tests
tests_med <- c(validation_med_HSI$Test.1, validation_med_HSI$Test.2)
outcomes_med <- c(validation_med_HSI$Test.1.Success, validation_med_HSI$Test.2.Success)
tests_outcomes_med <- data.frame(tests_med, outcomes_med) %>%
  na.omit

#calculating percent of the time right
mean(tests_outcomes_med$outcomes == 'Yes')

#visualizing using a bar plot 
ggplot(tests_outcomes_med, aes(x = outcomes_med, fill = outcomes_med)) + 
  geom_bar(color = 'black', show.legend = FALSE) +
  scale_fill_manual(values = c('gold2', 'grey2')) + 
  labs(title = 'Outcomes of Soft Tissue Watchlist (Medium Risk)',
       x = 'Injury Occured After Deemed Medium Risk',
       y = 'Number of Observations') + 
  theme_bw()
```

There appear to be no observations of HSI following a player being deemed as "Medium" risk for injury.

## Players Deemed Routine Risk

```{r}
#filtering just the low risk athletes from the watchlist
Riskstatus_rout <- Riskstatus %>%
  filter(Status == 'Routine') %>%
  mutate(Date = as.Date(Date, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(DateRisk = paste0(Date, collapse = " and "))

#creating a list of the unique athlete ids that were deemed high risk
rout_risk <- unique(Riskstatus_rout$anon_id)
```

```{r}
#filtering the incident report to only show those deemed low risk with only lower body injuries as well as only HSI related injuries
incident_rout_all <- Incident %>%
  filter(anon_id %in% rout_risk, Body.Part %in% lower_body) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

incident_rout_HSI <- Incident %>%
  filter(anon_id %in% rout_risk, OSICS14.Code %in% hamstring_OSICS14) %>%
  group_by(anon_id, Date.of.Injury...Onset.of.symptoms) %>%
  mutate(Total.Time.Injured = sum(Total.Time.Injured, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(across(everything())) %>%
  summarise(.groups = 'drop')

#consolidates all injuries for these athletes into one column
incident_rout_all2 <- incident_rout_all %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))

incident_rout_HSI2 <- incident_rout_HSI %>%
  mutate(Date = as.Date(Date.of.Injury...Onset.of.symptoms, format = '%m/%d/%Y')) %>%
  arrange(Date) %>%
  group_by(anon_id) %>%
  summarize(Outcome = paste0(FinalDiagnosisIncidentDate, collapse = " and "))
```

Player ID_489 has a duplicate injury with both 'Left Knee medial collateral ligament injury' and 'Left Grade 2 MCL tear knee' being listed for 11/23/24, but this is not as important to us. Player ID_595 has a duplicate injury of 'Left Ankle sprains' on 08/15/24. 

```{r, warning = FALSE}
#combines the dates the athletes were deemed high risk with their injuries and separates the injury occurrences and dates
validation_rout_all <- left_join(Riskstatus_rout, incident_rout_all2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4', 'Injury.5', 'Injury.6', 'Injury.7', 'Injury.8'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

#combines the above but specifically for HSI and includes T/F for whether the athlete suffered their injury after their high risk assessment
validation_rout_HSI <- left_join(Riskstatus_rout, incident_rout_HSI2, by = 'anon_id') %>%
  separate(Outcome, c('Injury.1', 'Injury.2', 'Injury.3', 'Injury.4'), sep = ' and ') %>%
  separate(DateRisk, c('Test.1', 'Test.2'), sep = ' and ')

validation_rout_HSI <- validation_rout_HSI %>%
  mutate(Injury.1.After = as.Date(str_sub(validation_rout_HSI$Injury.1, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.2.After = as.Date(str_sub(validation_rout_HSI$Injury.2, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.3.After = as.Date(str_sub(validation_rout_HSI$Injury.3, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.4.After = as.Date(str_sub(validation_rout_HSI$Injury.4, start = -10), format = '%m/%d/%Y') - as.Date(Test.1),
         Injury.1.After.2 = as.Date(str_sub(validation_rout_HSI$Injury.1, start = -10), format = '%m/%d/%Y') - as.Date(Test.2),
         Injury.2.After.2 = as.Date(str_sub(validation_rout_HSI$Injury.2, start = -10), format = '%m/%d/%Y') - as.Date(Test.2),
         Injury.3.After.2 = as.Date(str_sub(validation_rout_HSI$Injury.3, start = -10), format = '%m/%d/%Y') - as.Date(Test.2),
         Injury.4.After.2 = as.Date(str_sub(validation_rout_HSI$Injury.4, start = -10), format = '%m/%d/%Y') - as.Date(Test.2))
         
#adds columns that return 'Yes' if an injury occurred after the athlete was deemed high risk and a 'No' if no injury occurred after
validation_rout_HSI <- validation_rout_HSI %>%
         mutate(Test.1.Success = ifelse(is.na(Test.1), NA, ifelse(rowSums((select(., Injury.1.After:Injury.4.After) > 0), na.rm = TRUE) > 0, 'Yes', 'No')),
         Test.2.Success = ifelse(is.na(Test.2), NA, ifelse(rowSums((select(., Injury.1.After.2:Injury.4.After.2) > 0), na.rm = TRUE) > 0, 'Yes', 'No')))
```

### Visualizations

```{r}
#combining tests and injury outcomes and creating a data frame that just contains the dates of the test results and whether an injury occurred for the athlete after these tests
tests_rout <- c(validation_rout_HSI$Test.1, validation_rout_HSI$Test.2)
outcomes_rout <- c(validation_rout_HSI$Test.1.Success, validation_rout_HSI$Test.2.Success)
tests_outcomes_rout <- data.frame(tests_rout, outcomes_rout) %>%
  na.omit

#calculating percent of the time right
mean(tests_outcomes_rout$outcomes == 'Yes')

#visualizing using a bar plot 
ggplot(tests_outcomes_rout, aes(x = outcomes_rout, fill = outcomes_rout)) + 
  geom_bar(color = 'black', show.legend = FALSE) +
  scale_fill_manual(values = c('gold2', 'grey2')) + 
  labs(title = 'Outcomes of Soft Tissue Watchlist (Routine Risk)',
       x = 'Injury Occured After Deemed Routine Risk',
       y = 'Number of Observations') + 
  theme_bw()
```

Player ID_111 injured his left hamstring less than a month after the test and right hamstring a little over a month after the test. Should have been higher risk especially with injuring his left hamstring twice before the test. Player ID_220 injured his 280 days after the test which is quite a lot of time. Player ID_238 also injured his 238 days after the test. Player ID_247 hurt his hamstring 40 days from the test. Player ID_430 hurt his hamstring 47 days from his first test similarily. Player ID_485 and ID_50 hurt his hamstring in just over a month from the test. Player ID_75 hurt his in under 4 months from the test. 

ID_111, ID_247, ID_430, ID_50, ID_485 (Tendon Injury), ID_75











